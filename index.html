<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>支點運動_私課預約</title>
  
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      --bg:#f6f7f8;
      --card:#ffffff;
      --text:#111;
      --muted:#7a7a7a;
      --primary:#1bb57a;
      --highlight:#0056b3;
      --border:rgba(0,0,0,.08);
      --shadow:0 10px 26px rgba(0,0,0,.08);
      --radius:18px;
      --danger:#b23a2b; /* 深紅色 */
      --safeB: env(safe-area-inset-bottom, 0px);
      --safeT: env(safe-area-inset-top, 0px);
      --selBg:#e3f9ef;
      --selText:#0d7a55;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; overflow:hidden; }
    body{ margin:0; font-family: system-ui, -apple-system, sans-serif; background:var(--bg); color:var(--text); }

    .wrap{ height:100dvh; display:flex; flex-direction:column; max-width:560px; margin:0 auto; position:relative; }
    .page-section { position: absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; background:var(--bg); transition: opacity 0.2s; z-index:1; }
    .page-section.hidden { opacity:0; z-index:-1; pointer-events:none; }

    .top{ padding:10px 14px 8px; padding-top:calc(10px + var(--safeT)); flex:0 0 auto; background:linear-gradient(180deg, #f6f7f8 75%, rgba(246,247,248,0)); }
    .steps{ display:flex; gap:10px; align-items:center; justify-content:space-between; background:var(--card); border:1px solid var(--border); border-radius:999px; padding:10px 12px; box-shadow:var(--shadow); }
    .step{ display:flex; align-items:center; gap:8px; flex:1; justify-content:center; }
    .dot{ width:30px; height:30px; border-radius:999px; background:#e9f7f0; color:var(--primary); font-weight:900; display:flex; align-items:center; justify-content:center; font-size:14px; }
    .dot.active{ background:var(--primary); color:#fff; }
    .label{ font-size:15px; font-weight:900; color:var(--muted); white-space:nowrap; }
    .label.active{ color:var(--text); }

    .main{ flex:1 1 auto; overflow:hidden; padding:0 14px; display:flex; flex-direction:column; gap:12px; }
    .card{ background:var(--card); border-radius:var(--radius); border:1px solid var(--border); box-shadow:var(--shadow); padding:14px; overflow:hidden; display:flex; flex-direction:column; }
    .h{ margin:0 0 10px; font-weight:950; font-size:22px; color:#111; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }

    .chip{ padding:14px 16px; border-radius:16px; background:#eeeeee; font-weight:950; font-size:18px; cursor:pointer; min-width:140px; text-align:center; flex:1 1 0; border:2px solid transparent; }
    .chip.sel{ background:#dff4ea; border-color:rgba(27,181,122,.45); box-shadow:0 0 0 3px rgba(27,181,122,.14) inset; }
    .chip.peoplemp{ flex:1 1 0; min-width:140px; font-size:18px; }

    .coachIntro{ display:flex; gap:10px; align-items:center; border:1px solid rgba(0,0,0,.08); border-radius:16px; padding:10px; background:#fff; flex:0 0 auto; }
    .avatar{ width:48px; height:48px; border-radius:999px; overflow:hidden; background:#ddd; flex:0 0 auto; }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .coachMeta{ flex:1; min-width:0; }
    .coachName{ font-weight:950; font-size:18px; margin:0 0 6px; }
    .tags{ display:flex; gap:6px; flex-wrap:wrap; }
    .tag{ padding:6px 9px; border-radius:999px; background:#eaf8f2; color:#157a55; font-weight:900; font-size:11px; }

    .cal{ border-radius:18px; border:1px solid rgba(0,0,0,.08); padding:10px; background:#fff; flex:0 0 auto; }
    .calHead{ display:grid; grid-template-columns:42px 1fr 42px; gap:10px; align-items:center; margin-bottom:6px; }
    .calBtn{ width:42px; height:42px; border-radius:14px; background:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:950; color:#0d7a55; border:1px solid rgba(0,0,0,.08); }
    .calBtn.disabled{ opacity:0.3; pointer-events:none; background:#f0f0f0; color:#999; }
    .weekStrip{ display:grid; grid-template-columns:repeat(7, 1fr); gap:8px; }
    .dayCell{ display:flex; flex-direction:column; align-items:center; gap:6px; padding:6px 0; border-radius:14px; border:1px solid rgba(0,0,0,.06); background:#fff; cursor:pointer; min-height:64px; }
    .dayCell.disabled{ opacity:.35; pointer-events:none; }
    .dayCell.hidden{ visibility:hidden; pointer-events:none; }
    .dayCell.sel .dateDot{ background:var(--primary); color:#fff; }
    .dateDot{ width:34px; height:34px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:950; }

    .slotsArea{ flex:1 1 auto; min-height:0; display:flex; flex-direction:column; gap:10px; overflow:hidden; }
    .tabs{ display:flex; gap:22px; border-bottom:2px solid rgba(0,0,0,.08); padding-bottom:8px; flex:0 0 auto; }
    .tab{ font-weight:950; font-size:16px; color:#666; cursor:pointer; padding-bottom:10px; position:relative; }
    .tab.active{ color:#111; }
    .tab.active::after{ content:""; position:absolute; left:0; right:0; bottom:-2px; height:5px; background:var(--primary); border-radius:999px; }
    
    .slotGrid{ display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; overflow:auto; padding-right:2px; flex:1; min-height:0; align-content:start; }
    .slot{ padding:10px 0; border-radius:999px; background:#ededed; font-weight:950; font-size:13px; text-align:center; cursor:pointer; border:2px solid transparent; }
    .slot.sel{ background:var(--selBg); color:var(--selText); border-color:rgba(27,181,122,.35); box-shadow:0 0 0 3px rgba(27,181,122,.14) inset; }
    .slot.disabled{ opacity:.35; pointer-events:none; }
    
    /* ★ 提示文字：深紅粗體 ★ */
    .slotTip{ grid-column:1/-1; padding:8px 2px; font-size:14px; font-weight:900; color:var(--danger); }

    /* 購物車 */
    .cartSection { margin-top:8px; padding-top:8px; border-top:1px solid rgba(0,0,0,0.08); display:flex; flex-direction:column; gap:8px; flex:0 0 auto; max-height:160px; overflow-y:auto; padding-bottom:10px; }
    .cartItem { 
        display:flex; justify-content:space-between; align-items:center; 
        background:#fff; border-radius:12px; padding:12px 14px; 
        font-size:14px; font-weight:950; color:#333; 
        border:1px solid rgba(0,0,0,.08); 
        border-left:6px solid var(--primary); 
        box-shadow: 0 2px 5px rgba(0,0,0,0.03);
    }
    .cartActions { display: flex; align-items: center; gap: 10px; }
    .repeatBtn { font-size: 11px; padding: 4px 10px; border-radius: 8px; background: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; cursor: pointer; font-weight: 900; letter-spacing: 0.5px; }
    .delBtn { width: 24px; height: 24px; font-size: 18px; display: flex; align-items: center; justify-content: center; color: #d33; cursor: pointer; opacity: 0.6; }

    .confirmList { display:flex; flex-direction:column; gap:8px; max-height:250px; overflow-y:auto; margin-bottom:10px; }
    .confirmItem { background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:14px 16px; font-size:15px; font-weight:900; color:#111; display:flex; justify-content:space-between; align-items:center; }

    .footer{ padding:10px 14px 12px; background:linear-gradient(0deg, #f6f7f8 72%, rgba(246,247,248,0)); flex:0 0 auto; }
    .btnRow{ display:flex; gap:12px; }
    .btn{ flex:1; border:0; border-radius:16px; padding:14px 12px; font-size:16px; font-weight:950; cursor:pointer; box-shadow:var(--shadow); text-align:center; }
    .btnPrimary{ background:var(--primary); color:#fff; }
    .btnGhost{ background:#fff; color:#111; border:1px solid rgba(0,0,0,.10); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .status{ margin-top:8px; font-size:12px; color:var(--muted); text-align:center; font-weight:900; min-height:18px; white-space:pre-wrap; }
    .hide{ display:none !important; }

    .historyList { display:flex; flex-direction:column; gap:10px; overflow-y:auto; flex:1; padding-bottom:20px; }
    .historyItem { background:#fff; border-left:4px solid var(--primary); border-radius:12px; padding:14px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 6px rgba(0,0,0,0.04); }
    .historyItem.cancelled { border-left-color:#aaa; opacity:0.6; }
    .btnCancel { padding:6px 12px; background:#fff0f0; color:#d33; border:1px solid #fcc; border-radius:8px; font-size:12px; font-weight:900; cursor:pointer; }

    .swal2-popup { font-family: system-ui !important; border-radius: 20px !important; }
  </style>
</head>

<body>
<div class="wrap">

  <div id="page-booking" class="page-section">
    <div class="top">
      <div class="steps">
        <div class="step"> <div id="dot1" class="dot active">1</div> <div id="lab1" class="label active">選教練</div> </div>
        <div class="step"> <div id="dot2" class="dot">2</div> <div id="lab2" class="label">選日期</div> </div>
        <div class="step"> <div id="dot3" class="dot">3</div> <div id="lab3" class="label">確認</div> </div>
      </div>
    </div>

    <div class="main">
      <div id="card1" class="card">
        <div class="h">Step 1｜選擇教練</div>
        <div id="coachRow" class="row"></div>
        <div class="subTitle" style="margin:14px 0 10px; font-weight:950; font-size:15px;">選擇人數</div>
        <div id="peopleRow" class="row"></div>
      </div>

      <div id="card2" class="card hide" style="flex:1; min-height:0;">
        <div class="step2Box" style="display:flex; flex-direction:column; height:100%; gap:10px;">
          <div class="h">Step 2｜選擇時段</div>
          <div class="coachIntro">
             <div class="avatar"><img id="coachAvatar2" alt="" /></div>
             <div class="coachMeta">
               <div id="coachName2" class="coachName">—</div>
               <div id="coachTags2" class="tags"></div>
             </div>
          </div>
          <div class="cal">
            <div class="calHead">
              <div id="prevWeek" class="calBtn">‹</div>
              <div id="monthTitle" class="monthTitle">—</div>
              <div id="nextWeek" class="calBtn">›</div>
            </div>
            <div id="weekStrip" class="weekStrip"></div>
          </div>
          <div class="slotsArea">
            <div class="tabs">
               <div class="tab active" data-tab="am">上午</div>
               <div class="tab" data-tab="pm">下午</div>
               <div class="tab" data-tab="night">晚上</div>
            </div>
            
            <div id="slotGrid2" class="slotGrid"></div>
          </div>
          
          <div class="cartSection">
             <div id="cartList"></div>
          </div>
        </div>
      </div>

      <div id="card3" class="card hide" style="flex:1; min-height:0;">
        <div class="h">Step 3｜確認預約時段</div>
        <div id="confirmHeader" style="margin-bottom:10px; font-weight:900; font-size:1.1em;"></div>
        <div id="confirmList" class="confirmList"></div>
        <div style="margin-top:auto; background:#fff5f5; padding:12px; border-radius:12px; color:#b23a2b; font-size:13px; font-weight:900; line-height:1.5;">
           溫馨提醒：<br>1. 預約及取消請在課堂開始前 <span style="font-size:1.2em;color:#d33;">2</span> 小時執行。<br>2. 若某時段已被預約，將直接取消該時段預約。
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="btnRow">
        <button id="btnBack" class="btn btnGhost hide">上一步</button>
        <button id="btnNext" class="btn btnPrimary" disabled>下一步</button>
      </div>
      <div id="status" class="status"></div>
    </div>
  </div>

  <div id="page-history" class="page-section hidden">
    <div class="top" style="background:var(--bg);">
      <div class="h" style="font-size:20px;">我的預約紀錄</div>
    </div>
    <div class="main" style="padding-top:0;">
      <div id="historyLoading" class="status" style="margin-top:20px;">讀取中...</div>
      <div id="historyList" class="historyList"></div>
    </div>
    <div class="footer">
       <button id="btnRefresh" class="btn btnGhost">↻ 重新整理</button>
    </div>
  </div>

</div>

<script>
  const LIFF_ID = '2008631386-AEejMove'; 
  const MAKE_OPTIONS_WEBHOOK_URL = 'https://hook.us2.make.com/895459nt1ywk5dtvr9x31tis495coyw3';
  const MAKE_BOOKING_WEBHOOK_URL = 'https://hook.us2.make.com/895459nt1ywk5dtvr9x31tis495coyw3';

  // ID 與 Name 統一為中文
  const COACHES = [
    { id:'偉銘', name:'偉銘', avatar:'https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=240&q=80', tags:['肌力訓練','樂齡運動'] },
    { id:'教練 B', name:'教練 B', avatar:'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=240&q=80', tags:['肌力訓練','姿勢調整'] },
  ];

  const state = {
    step: 1, uid: '', name: '', coach: null, people: null,
    weekStart: null, dateKey: null, tab: 'am',
    cart: [],
    optionsRaw: [], availabilityMap: {}, loadingOptions: false
  };

  const $ = s => document.querySelector(s);
  const pad2 = n => String(n).padStart(2,'0');
  const ymd = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const startOfDay = d => new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const addDays = (d,n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x; };
  const getWd = dKey => ['日','一','二','三','四','五','六'][new Date(dKey+'T00:00:00').getDay()];
  const weekStartMonday = d => { const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const day=x.getDay(); x.setDate(x.getDate() + (day===0?-6:1-day)); return x; };
  function getLimitDate(){ const d = new Date(); d.setMonth(d.getMonth()+2,0); d.setHours(23,59,59,999); return d; }

  function canBookNow(dateKey, timeStr){
    if(!dateKey || !timeStr) return false;
    const dt = new Date(dateKey+'T00:00:00'); const [hh,mm]=timeStr.split(':');
    dt.setHours(hh,mm,0); return dt >= new Date(Date.now()+7200000); 
  }

  // ★ 2. 狀態列文字邏輯：Step 2 只顯示購物車 ★
  function updateStatusText(){
     const coachStr = state.coach ? state.coach.name : '—';
     const pplStr = state.people ? `${state.people}人` : '—';
     
     if(state.step === 1){
        if(!state.coach) $('#status').textContent = '請選擇教練';
        else if(!state.people) $('#status').textContent = `已選教練：${coachStr}｜請選擇人數`;
        else $('#status').textContent = `已選教練：${coachStr}｜人數：${pplStr}`;
     }
     else if(state.step === 2){
        if(state.cart.length > 0) $('#status').textContent = `已選擇預約清單：${state.cart.length} 堂`;
        else $('#status').textContent = '已選擇預約清單：尚未選擇';
     }
     else { $('#status').textContent = ''; }
     $('#status').classList.remove('statusError');
  }

  async function init(){
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){ liff.login(); return; }
    const p = await liff.getProfile();
    state.uid = p.userId;
    state.name = p.displayName;

    const urlParams = new URLSearchParams(window.location.search);
    if(urlParams.get('page') === 'history'){
       showPage('history');
       loadHistory();
    } else {
       showPage('booking');
       initBooking();
    }
    $('#btnRefresh').onclick = loadHistory;
  }

  function showPage(pageName){
     document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
     $(`#page-${pageName}`).classList.remove('hidden');
  }

  function initBooking(){
    renderCoaches(); renderPeople();
    state.weekStart = weekStartMonday(new Date()); renderWeekStrip();

    $('#prevWeek').onclick = () => { state.weekStart = addDays(state.weekStart, -7); renderWeekStrip(); renderSlotsStep2(); };
    $('#nextWeek').onclick = () => { state.weekStart = addDays(state.weekStart, 7); renderWeekStrip(); renderSlotsStep2(); };
    
    document.querySelectorAll('.tab').forEach(t => t.onclick = (e) => {
        document.querySelectorAll('.tab').forEach(x => { x.classList.remove('active'); x.style.color='#999'; });
        e.target.classList.add('active'); e.target.style.color='#111';
        state.tab = e.target.dataset.tab; renderSlotsStep2();
    });

    $('#btnBack').onclick = () => setStep(state.step - 1);
    $('#btnNext').onclick = handleNext;
    setStep(1);
  }

  function setStep(n){
    state.step = n;
    [1,2,3].forEach(i => {
       $(`#dot${i}`).classList.toggle('active', i===n);
       $(`#lab${i}`).classList.toggle('active', i===n);
       $(`#card${i}`).classList.toggle('hide', i!==n);
    });
    $('#btnBack').classList.toggle('hide', n===1);
    $('#btnNext').textContent = n===3 ? '確認送出' : '下一步';
    
    updateStatusText();
    updateBtnState();

    if(n===2) { renderCart(); }
    if(n===3) renderConfirm();
  }

  function updateBtnState(){
    const btn = $('#btnNext');
    if(state.step===1) btn.disabled = !(state.coach && state.people);
    if(state.step===2) btn.disabled = state.cart.length === 0;
  }

  function renderCoaches(){
    const row = $('#coachRow'); row.innerHTML = '';
    COACHES.forEach(c => {
       const div = document.createElement('div');
       div.className = 'chip' + (state.coach?.id===c.id ? ' sel':'');
       div.textContent = c.name;
       div.onclick = () => { state.coach=c; renderCoaches(); renderPeople(); updateBtnState(); updateStatusText(); };
       row.appendChild(div);
    });
  }

  function renderPeople(){
    const row = $('#peopleRow'); row.innerHTML = '';
    [1,2].forEach(n => {
       const div = document.createElement('div');
       div.className = 'chip peoplemp' + (state.people===n ? ' sel':'');
       div.textContent = n + ' 人';
       div.onclick = () => { state.people=n; renderPeople(); updateBtnState(); updateStatusText(); };
       row.appendChild(div);
    });
  }

  function renderCoachIntro(){
    if(!state.coach) return;
    $('#coachAvatar2').src = state.coach.avatar;
    $('#coachName2').textContent = state.coach.name;
    $('#coachTags2').innerHTML = state.coach.tags.map(t=>`<div class="tag">${t}</div>`).join('');
  }

  function renderWeekStrip(){
    const list = $('#weekStrip'); list.innerHTML='';
    $('#monthTitle').textContent = `${state.weekStart.getMonth()+1}月`;
    const limitDate = getLimitDate();
    
    for(let i=0; i<7; i++){
       const d = addDays(state.weekStart, i);
       const key = ymd(d);
       const el = document.createElement('div');
       el.className = 'dayCell' + (state.dateKey===key ? ' sel':'');
       if(startOfDay(d) < startOfDay(new Date()) || d > limitDate) el.classList.add('disabled');
       if(d > limitDate) el.classList.add('hidden');
       
       el.innerHTML = `<div style="font-size:11px;color:#666;">${['一','二','三','四','五','六','日'][i]}</div>
                       <div class="dateDot">${d.getDate()}</div>`;
       el.onclick = () => { 
          if(!el.classList.contains('disabled')){ 
             state.dateKey=key; renderWeekStrip(); loadOptions(); 
             updateStatusText();
          } 
       };
       list.appendChild(el);
    }
  }

  async function loadOptions(){
     state.loadingOptions = true; 
     renderSlotsStep2(); // 先渲染「搜尋中」文字
     updateStatusText();
     renderCoachIntro();
     try {
       // ★ 1. 只傳 coachName (完全移除 coachId) ★
       const res = await fetch(MAKE_OPTIONS_WEBHOOK_URL, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ 
              action: 'getOptions', 
              coachName: state.coach.name, 
              date: state.dateKey 
          })
       });
       const data = await res.json();
       state.optionsRaw = data.options || []; 
       state.availabilityMap = { [state.dateKey]: state.optionsRaw };
     } catch(e){ console.error(e); }
     state.loadingOptions = false; renderSlotsStep2(); updateStatusText();
  }

  function toggleCartItem(date, time){
     const idx = state.cart.findIndex(c => c.date===date && c.time===time);
     if(idx >= 0) {
        state.cart.splice(idx, 1);
     } else {
        const d = new Date(date+'T'+time);
        state.cart.push({ date, time, ts: d.getTime() });
     }
     renderSlotsStep2(); renderCart(); updateBtnState(); updateStatusText();
  }

  function addBatchItems(date, time){
     let current = new Date(date + 'T00:00:00');
     current = addDays(current, 7); 
     let count = 0;
     for(let i=0; i<3; i++){ 
        const dKey = ymd(current);
        const exists = state.cart.some(item => item.date === dKey && item.time === time);
        if(!exists && canBookNow(dKey, time)){
           state.cart.push({ date: dKey, time: time, ts: current.getTime() + parseInt(time.split(':')[0])*3600000 });
           count++;
        }
        current = addDays(current, 7);
     }
     renderCart(); renderSlotsStep2(); updateBtnState(); updateStatusText();
     Swal.fire({ icon:'success', title:'已加入包月', text:`成功加入後續 ${count} 堂`, timer:1000, showConfirmButton:false });
  }

  function renderSlotsStep2(){
     const grid = $('#slotGrid2'); grid.innerHTML='';
     
     // ★ 2. 提示文字優化：深紅粗體 ★
     if(state.loadingOptions) { 
        grid.innerHTML='<div class="slotTip">正在搜尋可預約的日期及時段...</div>'; 
        return; 
     }
     if(!state.dateKey) { 
        grid.innerHTML='<div class="slotTip" style="color:var(--danger);">請選擇日期及時段</div>'; 
        return; 
     }
     
     // ★ 3. 確保資料格式正確 (支援 label/value) ★
     const timesRaw = state.availabilityMap[state.dateKey] || [];
     const times = timesRaw.map(t => (typeof t === 'object' && t.label) ? t.label : t);

     const displayTimes = times.filter(t => {
        const h = parseInt(t);
        if(state.tab==='am') return h<12;
        if(state.tab==='pm') return h>=12 && h<18;
        return h>=18;
     });

     if(displayTimes.length===0) grid.innerHTML='<div class="slotTip">無可預約時段</div>';

     displayTimes.forEach(t => {
        const el = document.createElement('div');
        const inCart = state.cart.some(c => c.date===state.dateKey && c.time===t);
        const disabled = !canBookNow(state.dateKey, t);
        el.className = 'slot' + (inCart ? ' sel':'') + (disabled ? ' disabled':'');
        el.textContent = t;
        el.onclick = () => { if(!disabled) toggleCartItem(state.dateKey, t); };
        grid.appendChild(el);
     });
  }

  function renderCart(){
     const list = $('#cartList'); list.innerHTML='';
     if(state.cart.length===0) { list.innerHTML='<div style="padding:10px;text-align:center;color:#ccc;font-size:12px;">尚未選擇</div>'; return; }
     
     state.cart.sort((a,b)=>a.ts-b.ts).forEach(item => {
        const el = document.createElement('div'); el.className='cartItem';
        el.innerHTML = `
           <span>${item.date} (${getWd(item.date)}) ${item.time}</span>
           <div class="cartActions">
              <div class="repeatBtn" title="加入後3週">+包月</div>
              <div class="delBtn">×</div>
           </div>
        `;
        el.querySelector('.delBtn').onclick = (e) => { 
           e.stopPropagation(); toggleCartItem(item.date, item.time);
        };
        el.querySelector('.repeatBtn').onclick = (e) => {
           e.stopPropagation(); addBatchItems(item.date, item.time);
        };
        list.appendChild(el);
     });
  }

  function renderConfirm(){
     $('#confirmHeader').innerHTML = `預約教練：<span style="color:var(--highlight);">${state.coach.name}</span>`;
     
     const list = $('#confirmList'); list.innerHTML='';
     state.cart.sort((a,b)=>a.ts-b.ts).forEach(item => {
        const div = document.createElement('div'); div.className='confirmItem';
        div.innerHTML = `<span>${item.date} (${getWd(item.date)})</span>
                         <span>${item.time}</span>`;
        list.appendChild(div);
     });
     
     const total = document.createElement('div');
     total.style.cssText = "text-align:right; margin-top:8px; font-weight:950; color:var(--highlight); font-size:16px;";
     total.textContent = `共 ${state.cart.length} 堂課`;
     list.appendChild(total);
  }

  async function handleNext(){
     if(state.step===1) { await loadOptions(); setStep(2); return; }
     if(state.step===2) { setStep(3); return; }
     if(state.step===3) {
        $('#btnNext').disabled=true; $('#btnNext').textContent='處理中...';
        try {
           const payload = {
              action: 'book',
              userId: state.uid,
              displayName: state.name,
              coachName: state.coach.name,
              people: state.people,
              bookings: state.cart
           };
           const res = await fetch(MAKE_BOOKING_WEBHOOK_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
           const json = await res.json();
           
           if(json.status === 'success'){
              await Swal.fire({ icon:'success', title:'預約成功', text:'已發送通知', confirmButtonColor:'#1bb57a' });
              if(liff.isInClient()){
                 await liff.sendMessages([createSuccessFlex(state.cart)]).catch(e=>console.log(e));
              }
              liff.closeWindow();
           } else {
              throw new Error(json.message || '部分預約失敗');
           }
        } catch(e) {
           Swal.fire({ icon:'error', title:'預約失敗', text: e.message });
           $('#btnNext').disabled=false; $('#btnNext').textContent='確認送出';
        }
     }
  }

  function createSuccessFlex(list){
     return {
        type: "flex", altText: "預約成功",
        contents: {
           type: "bubble",
           header: {
              type: "box", layout: "vertical", backgroundColor: "#1bb57a", paddingAll: "20px",
              contents: [
                 { type: "text", text: "私課預約成功", weight: "bold", size: "xl", color: "#ffffff" },
                 { type: "text", text: "支點運動空間", size: "xs", color: "#eeeeee", margin: "sm" }
              ]
           },
           body: {
              type: "box", layout: "vertical", backgroundColor: "#f5fcf9", paddingAll: "20px",
              contents: [
                 { type: "text", text: "已成功預約", weight: "bold", size: "lg", color: "#111111", align: "center" },
                 { type: "text", text: `${list.length} 堂課程`, weight: "bold", size: "xxl", color: "#1bb57a", align: "center", margin: "md" },
                 { type: "text", text: `教練：${state.coach.name}`, color: "#555555", align: "center", margin: "lg" }
              ]
           },
           footer: {
              type: "box", layout: "vertical",
              contents: [
                 {
                    type: "box", layout: "vertical", backgroundColor: "#1bb57a", cornerRadius: "12px", height: "56px", justifyContent: "center", alignItems: "center",
                    action: { type: "uri", label: "查看預約", uri: "https://liff.line.me/" + LIFF_ID + "?page=history" },
                    contents: [
                       { type: "text", text: "查看預約", color: "#ffffff", size: "xl", weight: "900" }
                    ]
                 }
              ]
           }
        }
     };
  }

  async function loadHistory(){
     const listDiv = $('#historyList');
     const loading = $('#historyLoading');
     listDiv.innerHTML = '';
     loading.classList.remove('hide');
     
     try {
        const res = await fetch(MAKE_BOOKING_WEBHOOK_URL, {
           method: 'POST', headers: {'Content-Type':'application/json'},
           body: JSON.stringify({ action: 'get_history', userId: state.uid })
        });
        const data = await res.json();
        const records = data.records || []; 

        loading.classList.add('hide');
        if(records.length === 0){
           listDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">目前沒有預約紀錄</div>';
           return;
        }

        records.forEach(r => {
           const el = document.createElement('div');
           el.className = 'historyItem';
           if(r.status === 'canceled') el.classList.add('cancelled');

           const html = `
             <div style="display:flex;flex-direction:column;">
               <span style="font-size:15px;font-weight:900;color:#333;">${r.date} ${r.time}</span>
               <span style="font-size:12px;color:#888;">${r.coach}｜${r.people}人</span>
             </div>
           `;
           el.innerHTML = html;

           if(r.status !== 'canceled'){
              const btn = document.createElement('div');
              btn.className = 'btnCancel';
              btn.textContent = '取消';
              btn.onclick = () => handleCancel(r.id || `${r.date}_${r.time}`, r.date, r.time);
              el.appendChild(btn);
           } else {
              el.innerHTML += '<div style="font-size:12px;color:#aaa;">已取消</div>';
           }
           listDiv.appendChild(el);
        });

     } catch(e) {
        console.error(e);
        loading.textContent = '載入失敗，請稍後再試';
     }
  }

  async function handleCancel(id, date, time){
     const result = await Swal.fire({
        title: '確定取消?',
        text: `取消預約：${date} ${time}`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#b23a2b',
        confirmButtonText: '確定取消',
        cancelButtonText: '返回'
     });

     if(result.isConfirmed){
        try {
           Swal.showLoading();
           await fetch(MAKE_BOOKING_WEBHOOK_URL, {
              method: 'POST', headers: {'Content-Type':'application/json'},
              body: JSON.stringify({ action: 'cancel', userId: state.uid, bookingId: id, date: date, time: time })
           });
           await Swal.fire({ icon:'success', title:'已取消', timer:1500, showConfirmButton:false });
           loadHistory();
        } catch(e){
           Swal.fire('錯誤', '取消失敗', 'error');
        }
     }
  }

  init();
</script>
</body>
</html>
