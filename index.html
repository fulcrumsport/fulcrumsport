<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>æ”¯é»é‹å‹•_ç§èª²é ç´„</title>
  
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* åŸºç¤è®Šæ•¸ */
    :root{ --bg:#f6f7f8; --card:#ffffff; --text:#111; --muted:#7a7a7a; --primary:#1bb57a; --border:rgba(0,0,0,.08); --shadow:0 10px 26px rgba(0,0,0,.08); --radius:18px; --danger:#b23a2b; --safeB: env(safe-area-inset-bottom, 0px); --safeT: env(safe-area-inset-top, 0px); }
    *{ box-sizing:border-box; }
    html, body{ height:100%; overflow:hidden; }
    body{ margin:0; font-family: system-ui, -apple-system, sans-serif; background:var(--bg); color:var(--text); }
    
    /* ç‰ˆé¢é…ç½® */
    .wrap{ height:100dvh; display:flex; flex-direction:column; max-width:560px; margin:0 auto; position:relative; }
    .content-area { flex: 1; overflow: hidden; display: flex; flex-direction: column; position: relative; }
    
    /* é é¢å®¹å™¨ (ç”¨æ–¼åˆ‡æ› é ç´„/ç´€éŒ„) */
    .page-view { 
      position: absolute; top:0; left:0; width:100%; height:100%; 
      display: flex; flex-direction: column; 
      transition: opacity 0.2s; opacity: 1; z-index: 1;
      background: var(--bg);
    }
    .page-view.hidden { opacity: 0; z-index: -1; pointer-events: none; }

    /* ====== å…±ç”¨å…ƒä»¶ ====== */
    .top{ padding:10px 14px 8px; padding-top:calc(10px + var(--safeT)); flex:0 0 auto; background: var(--bg); }
    .h{ margin:0 0 10px; font-weight:950; font-size:22px; color:#111; }
    .card{ background:var(--card); border-radius:var(--radius); border:1px solid var(--border); box-shadow:var(--shadow); padding:14px; overflow:hidden; display:flex; flex-direction:column; margin-bottom: 12px; }
    .btn{ border:0; border-radius:16px; padding:14px 12px; font-size:16px; font-weight:950; cursor:pointer; box-shadow:var(--shadow); text-align:center; }
    .btnPrimary{ background:var(--primary); color:#fff; }
    .btnGhost{ background:#fff; color:#111; border:1px solid rgba(0,0,0,.10); }
    .btnDanger{ background:var(--danger); color:#fff; }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .hide{ display:none !important; }

    /* ====== é ç´„é é¢æ¨£å¼ (åŸæœ‰) ====== */
    .steps{ display:flex; gap:10px; align-items:center; justify-content:space-between; background:var(--card); border:1px solid var(--border); border-radius:999px; padding:10px 12px; box-shadow:var(--shadow); margin-bottom: 10px;}
    .step{ display:flex; align-items:center; gap:8px; flex:1; justify-content:center; }
    .dot{ width:30px; height:30px; border-radius:999px; background:#e9f7f0; color:var(--primary); font-weight:900; display:flex; align-items:center; justify-content:center; font-size:14px; }
    .dot.active{ background:var(--primary); color:#fff; }
    .label{ font-size:15px; font-weight:900; color:var(--muted); white-space:nowrap; }
    .label.active{ color:var(--text); }

    .main{ flex:1 1 auto; overflow:hidden; padding:0 14px; display:flex; flex-direction:column; min-height:0; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .chip{ padding:14px 16px; border-radius:16px; background:#eeeeee; font-weight:950; font-size:18px; cursor:pointer; min-width:140px; text-align:center; flex:1 1 0; border:2px solid transparent; }
    .chip.sel{ background:#dff4ea; border-color:rgba(27,181,122,.45); }
    .subTitle{ margin:14px 0 10px; font-weight:950; font-size:15px; }
    
    /* æ—¥æ›†èˆ‡æ™‚æ®µ */
    .step2Box{ display:flex; flex-direction:column; gap:10px; height:100%; min-height:0; }
    .cal{ border-radius:18px; border:1px solid rgba(0,0,0,.08); padding:10px; background:#fff; flex:0 0 auto; }
    .calHead{ display:grid; grid-template-columns:42px 1fr 42px; gap:10px; align-items:center; margin-bottom:6px; }
    .calBtn{ width:42px; height:42px; border-radius:14px; background:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:950; color:#0d7a55; border:1px solid rgba(0,0,0,.08); }
    .weekStrip{ display:grid; grid-template-columns:repeat(7, 1fr); gap:8px; }
    .dayCell{ display:flex; flex-direction:column; align-items:center; gap:6px; padding:6px 0; border-radius:14px; border:1px solid rgba(0,0,0,.06); background:#fff; cursor:pointer; min-height:64px; }
    .dayCell.sel .dateDot{ background:var(--primary); color:#fff; }
    .dateDot{ width:34px; height:34px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:950; }
    .slotsArea{ flex:1 1 auto; min-height:0; display:flex; flex-direction:column; gap:10px; overflow:hidden; }
    .slotGrid{ display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; overflow:auto; padding-right:2px; }
    .slot{ padding:10px 0; border-radius:999px; background:#ededed; font-weight:950; font-size:13px; text-align:center; cursor:pointer; border:2px solid transparent; }
    .slot.sel{ background:#e3f9ef; color:#0d7a55; border-color:rgba(27,181,122,.35); }
    .slot.disabled, .dayCell.disabled { opacity:.35; pointer-events:none; }
    .dayCell.hidden { visibility:hidden; pointer-events:none; }

    /* è³¼ç‰©è»Šèˆ‡ç¢ºèªåˆ—è¡¨ */
    .cartSection { margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.08); display: flex; flex-direction: column; gap: 6px; flex: 0 0 auto; max-height: 120px; overflow-y: auto; background: #fafafa; border-radius: 12px; padding: 8px; }
    .cartItem, .confirmItem, .historyItem { display: flex; align-items: center; justify-content: space-between; background: #fff; border: 1px solid #ddd; border-left: 4px solid var(--primary); border-radius: 8px; padding: 12px 16px; font-size: 14px; font-weight: 950; color: #333; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
    .confirmItem, .historyItem { padding: 14px 16px; font-size: 15px; }
    
    /* é ç´„åˆ—è¡¨å…§çš„æ–‡å­—ç¾¤çµ„ */
    .item-group { display: flex; gap: 12px; align-items: center; }
    .item-ppl { color: #111; font-weight: 900; margin-left: auto; }

    .footer{ padding:10px 14px 12px; background:linear-gradient(0deg, #f6f7f8 72%, rgba(246,247,248,0)); flex:0 0 auto; }
    .btnRow{ display:flex; gap:12px; }
    .btn{ flex:1; }
    .status{ margin-top:8px; font-size:12px; color:var(--muted); text-align:center; font-weight:900; min-height:18px; }

    /* ====== ç´€éŒ„é é¢æ¨£å¼ (æ–°) ====== */
    .historyList { display: flex; flex-direction: column; gap: 10px; overflow-y: auto; padding-bottom: 20px; flex: 1; }
    .historyItem { border-left-color: #1bb57a; flex-wrap: wrap; gap: 10px; }
    .historyItem.cancelled { border-left-color: #aaa; opacity: 0.6; }
    .cancelBtn { padding: 6px 12px; font-size: 12px; border-radius: 8px; background: #ffebee; color: #b23a2b; border: 1px solid #ffcdd2; font-weight: 900; cursor: pointer; margin-left: auto; }
    
    /* ====== åº•éƒ¨å°è¦½åˆ— (Bottom Nav) ====== */
    .bottom-nav {
      flex: 0 0 auto;
      background: #fff;
      border-top: 1px solid rgba(0,0,0,0.08);
      display: flex;
      justify-content: space-around;
      padding-bottom: var(--safeB);
      box-shadow: 0 -4px 10px rgba(0,0,0,0.03);
    }
    .nav-item {
      flex: 1;
      padding: 10px 0;
      text-align: center;
      font-size: 11px;
      font-weight: 900;
      color: #999;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .nav-item.active { color: var(--primary); }
    .nav-icon { font-size: 20px; line-height: 1; }

    .swal2-popup { font-family: system-ui !important; border-radius: 20px !important; }
  </style>
</head>

<body>
<div class="wrap">
  
  <div class="content-area">
    
    <div id="view-booking" class="page-view">
      <div class="top">
        <div class="steps">
          <div class="step"> <div id="dot1" class="dot active">1</div> <div id="lab1" class="label active">é¸æ•™ç·´</div> </div>
          <div class="step"> <div id="dot2" class="dot">2</div> <div id="lab2" class="label">é¸æ—¥æœŸ</div> </div>
          <div class="step"> <div id="dot3" class="dot">3</div> <div id="lab3" class="label">ç¢ºèª</div> </div>
        </div>
      </div>

      <div class="main">
        <div id="card1" class="card">
          <div class="h">Step 1ï½œé¸æ“‡æ•™ç·´</div>
          <div id="coachRow" class="row"></div>
          <div class="subTitle">é¸æ“‡äººæ•¸</div>
          <div id="peopleRow" class="row"></div>
        </div>

        <div id="card2" class="card hide" style="flex:1; min-height:0;">
          <div class="step2Box">
            <div class="h">Step 2ï½œé¸æ“‡æ™‚æ®µ</div>
            <div class="cal">
              <div class="calHead">
                <div id="prevWeek" class="calBtn">â€¹</div>
                <div id="monthTitle" style="text-align:center;font-weight:950;">â€”</div>
                <div id="nextWeek" class="calBtn">â€º</div>
              </div>
              <div id="weekStrip" class="weekStrip"></div>
            </div>
            <div class="slotsArea">
              <div style="display:flex;gap:10px;border-bottom:2px solid #eee;padding-bottom:8px;margin-bottom:8px;">
                <div class="tab active" data-tab="am" style="font-weight:950;cursor:pointer;">ä¸Šåˆ</div>
                <div class="tab" data-tab="pm" style="font-weight:950;cursor:pointer;color:#999;">ä¸‹åˆ</div>
                <div class="tab" data-tab="night" style="font-weight:950;cursor:pointer;color:#999;">æ™šä¸Š</div>
              </div>
              <div id="slotGrid2" class="slotGrid"></div>
            </div>
            <div class="cartSection">
                <div style="font-size:12px;color:#888;font-weight:900;">å·²é¸æ“‡æ¸…å–®</div>
                <div id="cartList"></div>
            </div>
          </div>
        </div>

        <div id="card3" class="card hide" style="flex:1; min-height:0;">
          <div class="h">Step 3ï½œç¢ºèªé ç´„</div>
          <div id="confirmInfo" style="display:flex;flex-direction:column;gap:8px;"></div>
          <div style="margin-top:12px;background:#fff5f5;padding:12px;border-radius:12px;color:#b23a2b;font-size:13px;line-height:1.5;font-weight:900;">
            æº«é¦¨æé†’ï¼š<br>1. å–æ¶ˆæˆ–æ”¹æœŸï¼Œè«‹æ–¼é–‹èª²å‰ 1 å°æ™‚å®Œæˆã€‚<br>2. æŸæ™‚æ®µè‹¥å·²è¢«é ç´„ï¼Œç³»çµ±å°‡è‡ªå‹•å–æ¶ˆè©²ç­†é ç´„ã€‚
          </div>
        </div>
      </div>

      <div class="footer">
        <div class="btnRow">
          <button id="btnBack" class="btn btnGhost hide">ä¸Šä¸€æ­¥</button>
          <button id="btnNext" class="btn btnPrimary" disabled>ä¸‹ä¸€æ­¥</button>
        </div>
        <div id="status" class="status"></div>
      </div>
    </div>

    <div id="view-history" class="page-view hidden">
      <div class="top">
        <div class="h">æˆ‘çš„é ç´„ç´€éŒ„</div>
      </div>
      <div class="main" style="padding-top:0;">
        <div id="historyLoading" class="status">è¼‰å…¥ä¸­...</div>
        <div id="historyList" class="historyList"></div>
      </div>
      <div class="footer">
         <button id="btnRefresh" class="btn btnGhost">â†» é‡æ–°æ•´ç†</button>
      </div>
    </div>

  </div>

  <div class="bottom-nav">
    <div class="nav-item active" data-target="view-booking">
      <div class="nav-icon">ğŸ“…</div>
      <div>æˆ‘è¦é ç´„</div>
    </div>
    <div class="nav-item" data-target="view-history">
      <div class="nav-icon">ğŸ“‹</div>
      <div>æˆ‘çš„ç´€éŒ„</div>
    </div>
  </div>

</div>

<script>
  const LIFF_ID = '2008631386-AEejMove'; 
  
  // â˜…â˜…â˜… æ³¨æ„ï¼šé€™è£¡éœ€è¦æ‚¨çš„ Make Webhook URL â˜…â˜…â˜…
  // å¦‚æœæ‚¨çš„åŒä¸€å€‹ Webhook å¯ä»¥è™•ç†ä¸åŒ actionï¼Œå°±å¡«åŒä¸€å€‹
  // å»ºè­°å°‡ MAKE_BOOKING_WEBHOOK_URL å’Œ MAKE_QUERY_WEBHOOK_URL è¨­ç‚ºä¸€æ¨£ï¼Œç„¶å¾Œåœ¨ Make è£¡é¢ç”¨ Router åˆ†æµ
  const MAKE_WEBHOOK_URL = 'https://hook.us2.make.com/895459nt1ywk5dtvr9x31tis495coyw3';

  // --- æ¨¡æ“¬è³‡æ–™èˆ‡ç‹€æ…‹ ---
  const COACHES = [
    { id:'coachA', name:'å‰éŠ˜', avatar:'', tags:['è‚ŒåŠ›è¨“ç·´','æ¨‚é½¡é‹å‹•'] },
    { id:'coachB', name:'æ•™ç·´ B', avatar:'', tags:['è‚ŒåŠ›è¨“ç·´','å§¿å‹¢èª¿æ•´'] },
  ];

  const state = {
    // é ç´„æµç¨‹ç‹€æ…‹
    step: 1, uid: '', name: '', coach: null, people: null,
    weekStart: null, dateKey: null, tab: 'am',
    cart: [],
    optionsRaw: [], availabilityMap: {}, loadingOptions: false,
    
    // ç´€éŒ„é é¢ç‹€æ…‹
    history: []
  };

  // --- Helper Functions ---
  const $ = s => document.querySelector(s);
  const pad2 = n => String(n).padStart(2,'0');
  const ymd = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const addDays = (d,n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x; };
  const getWd = dKey => ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][new Date(dKey+'T00:00:00').getDay()];
  const weekStartMonday = d => { const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const day=x.getDay(); x.setDate(x.getDate() + (day===0?-6:1-day)); return x; };

  // --- ä»‹é¢åˆ‡æ›é‚è¼¯ (Tabs) ---
  function initTabs(){
    document.querySelectorAll('.nav-item').forEach(el => {
      el.onclick = () => {
        // åˆ‡æ› UI
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        document.querySelectorAll('.page-view').forEach(p => p.classList.add('hidden'));
        const targetId = el.dataset.target;
        document.getElementById(targetId).classList.remove('hidden');

        // å¦‚æœåˆ‡æ›åˆ°ç´€éŒ„é ï¼Œè‡ªå‹•è®€å–
        if(targetId === 'view-history'){
           loadHistory();
        }
      };
    });
  }

  // --- é ç´„æµç¨‹é‚è¼¯ (ä¿ç•™æ‚¨åŸæœ¬çš„é‚è¼¯ï¼Œç¨å¾®ç²¾ç°¡) ---
  function initBookingFlow(){
    // åˆå§‹åŒ–å…ƒä»¶
    renderCoaches(); renderPeople();
    state.weekStart = weekStartMonday(new Date()); renderWeekStrip();

    // ç¶å®šäº‹ä»¶
    $('#prevWeek').onclick = () => { state.weekStart = addDays(state.weekStart, -7); renderWeekStrip(); renderSlotsStep2(); };
    $('#nextWeek').onclick = () => { state.weekStart = addDays(state.weekStart, 7); renderWeekStrip(); renderSlotsStep2(); };
    
    document.querySelectorAll('.tab').forEach(t => t.onclick = (e) => {
        document.querySelectorAll('.tab').forEach(x => { x.classList.remove('active'); x.style.color='#999'; });
        e.target.classList.add('active'); e.target.style.color='#111';
        state.tab = e.target.dataset.tab; renderSlotsStep2();
    });

    $('#btnBack').onclick = () => setStep(state.step - 1);
    $('#btnNext').onclick = handleNext;
    
    setStep(1);
  }

  function setStep(n){
    state.step = n;
    // æ›´æ–°é»é»
    [1,2,3].forEach(i => {
       const dot = $(`#dot${i}`), lab = $(`#lab${i}`);
       dot.classList.toggle('active', i===n);
       lab.classList.toggle('active', i===n);
    });
    // åˆ‡æ›å¡ç‰‡
    $('#card1').classList.toggle('hide', n!==1);
    $('#card2').classList.toggle('hide', n!==2);
    $('#card3').classList.toggle('hide', n!==3);
    
    $('#btnBack').classList.toggle('hide', n===1);
    $('#btnNext').textContent = n===3 ? 'ç¢ºèªé€å‡º' : 'ä¸‹ä¸€æ­¥';
    $('#status').textContent = '';

    if(n===1) updateBtnState();
    if(n===2) { updateBtnState(); renderCart(); }
    if(n===3) renderConfirm();
  }

  function updateBtnState(){
    const btn = $('#btnNext');
    if(state.step===1) btn.disabled = !(state.coach && state.people);
    if(state.step===2) btn.disabled = state.cart.length === 0;
  }

  function renderCoaches(){
    const row = $('#coachRow'); row.innerHTML = '';
    COACHES.forEach(c => {
       const div = document.createElement('div');
       div.className = 'chip' + (state.coach?.id===c.id ? ' sel':'');
       div.textContent = c.name;
       div.onclick = () => { state.coach=c; renderCoaches(); renderPeople(); updateBtnState(); };
       row.appendChild(div);
    });
  }

  function renderPeople(){
    const row = $('#peopleRow'); row.innerHTML = '';
    [1,2].forEach(n => {
       const div = document.createElement('div');
       div.className = 'chip peoplemp' + (state.people===n ? ' sel':'');
       div.textContent = n + ' äºº';
       div.onclick = () => { state.people=n; renderPeople(); updateBtnState(); };
       row.appendChild(div);
    });
  }

  function renderWeekStrip(){
    const list = $('#weekStrip'); list.innerHTML='';
    $('#monthTitle').textContent = `${state.weekStart.getMonth()+1}æœˆ`;
    for(let i=0; i<7; i++){
       const d = addDays(state.weekStart, i);
       const key = ymd(d);
       const el = document.createElement('div');
       el.className = 'dayCell' + (state.dateKey===key ? ' sel':'');
       // ç°¡å–®é‚è¼¯ï¼šéæœŸåç°
       if(new Date(d.toDateString()) < new Date(new Date().toDateString())) el.classList.add('disabled');
       
       el.innerHTML = `<div style="font-size:11px;color:#666;">${['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'][i]}</div>
                       <div class="dateDot">${d.getDate()}</div>`;
       el.onclick = () => { if(!el.classList.contains('disabled')){ state.dateKey=key; renderWeekStrip(); loadOptions(); } };
       list.appendChild(el);
    }
  }

  async function loadOptions(){
     state.loadingOptions = true; renderSlotsStep2();
     try {
       // â˜… å‘¼å« Make å–å¾—æ™‚é–“ (action: getOptions)
       const res = await fetch(MAKE_WEBHOOK_URL, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ action: 'getOptions', coachId: state.coach.id, date: state.dateKey })
       });
       const data = await res.json();
       state.optionsRaw = data.options || []; // é æœŸæ ¼å¼: ["09:00", "10:00"...]
       state.availabilityMap = { [state.dateKey]: state.optionsRaw };
     } catch(e){ console.error(e); }
     state.loadingOptions = false; renderSlotsStep2();
  }

  function renderSlotsStep2(){
     const grid = $('#slotGrid2'); grid.innerHTML='';
     if(state.loadingOptions) { grid.innerHTML='<div class="slotTip">è¼‰å…¥ä¸­...</div>'; return; }
     if(!state.dateKey) { grid.innerHTML='<div class="slotTip">è«‹é¸æ“‡æ—¥æœŸ</div>'; return; }
     
     const times = state.availabilityMap[state.dateKey] || [];
     // ç°¡å–®åˆ†å€
     const displayTimes = times.filter(t => {
        const h = parseInt(t);
        if(state.tab==='am') return h<12;
        if(state.tab==='pm') return h>=12 && h<18;
        return h>=18;
     });

     if(displayTimes.length===0) grid.innerHTML='<div class="slotTip">ç„¡å¯é ç´„æ™‚æ®µ</div>';

     displayTimes.forEach(t => {
        const el = document.createElement('div');
        const inCart = state.cart.some(c => c.date===state.dateKey && c.time===t);
        el.className = 'slot' + (inCart ? ' sel':'');
        el.textContent = t;
        el.onclick = () => {
           // Toggle Cart
           const idx = state.cart.findIndex(c => c.date===state.dateKey && c.time===t);
           if(idx>=0) state.cart.splice(idx,1);
           else state.cart.push({ date:state.dateKey, time:t, ts: new Date(state.dateKey+'T'+t).getTime() });
           renderSlotsStep2(); renderCart(); updateBtnState();
        };
        grid.appendChild(el);
     });
  }

  function renderCart(){
     const list = $('#cartList'); list.innerHTML='';
     if(state.cart.length===0) { list.innerHTML='<div style="padding:10px;text-align:center;color:#ccc;">å°šæœªé¸æ“‡</div>'; return; }
     state.cart.sort((a,b)=>a.ts-b.ts).forEach(item => {
        const el = document.createElement('div'); el.className='cartItem';
        el.innerHTML = `<span>${item.date} (${getWd(item.date)}) ${item.time}</span>
                        <div class="delBtn" style="color:#ccc;">Ã—</div>`;
        el.querySelector('.delBtn').onclick = (e) => { e.stopPropagation(); 
           state.cart = state.cart.filter(c => c!==item); renderSlotsStep2(); renderCart(); updateBtnState();
        };
        list.appendChild(el);
     });
  }

  function renderConfirm(){
     const list = $('#confirmInfo'); list.innerHTML='';
     list.innerHTML = `<div style="font-weight:900;margin-bottom:4px;">é ç´„æ•™ç·´ï¼š${state.coach.name}</div>`;
     state.cart.sort((a,b)=>a.ts-b.ts).forEach(item => {
        // â˜…â˜…â˜… ç¢ºèªé æ’ç‰ˆ â˜…â˜…â˜…
        const div = document.createElement('div'); div.className='confirmItem';
        div.innerHTML = `<div class="item-group">
                           <span>${item.date} (${getWd(item.date)})</span>
                           <span>${item.time}</span>
                         </div>
                         <div class="item-ppl">${state.people} äºº</div>`;
        list.appendChild(div);
     });
     list.innerHTML += `<div style="text-align:right;font-weight:900;margin-top:8px;">å…± ${state.cart.length} å ‚èª²</div>`;
  }

  async function handleNext(){
     if(state.step===1) { await loadOptions(); setStep(2); return; }
     if(state.step===2) { setStep(3); return; }
     if(state.step===3) {
        // é€å‡ºé ç´„
        $('#btnNext').disabled=true; $('#btnNext').textContent='è™•ç†ä¸­...';
        try {
           const payload = {
              action: 'book', // Make ä¾æ­¤åˆ¤æ–·
              userId: state.uid,
              displayName: state.name,
              coach: state.coach.name,
              people: state.people,
              bookings: state.cart
           };
           const res = await fetch(MAKE_WEBHOOK_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
           const json = await res.json();
           
           if(json.status === 'success'){
              await Swal.fire({ icon:'success', title:'é ç´„æˆåŠŸ', text:'å·²ç™¼é€é€šçŸ¥', confirmButtonColor:'#1bb57a' });
              // å˜—è©¦ç™¼é€ Flex (æ¥µç°¡ç‰ˆ)
              if(liff.isInClient()){
                 liff.sendMessages([createSuccessFlex(state.cart)]).catch(e=>console.log(e));
              }
              liff.closeWindow();
           } else {
              throw new Error(json.message || 'éƒ¨åˆ†é ç´„å¤±æ•—');
           }
        } catch(e) {
           Swal.fire({ icon:'error', title:'é ç´„å¤±æ•—', text: e.message });
           $('#btnNext').disabled=false; $('#btnNext').textContent='ç¢ºèªé€å‡º';
        }
     }
  }

  function createSuccessFlex(list){
     return {
        type: "flex", altText: "é ç´„æˆåŠŸ",
        contents: {
           type: "bubble",
           body: {
              type: "box", layout: "vertical", spacing: "md",
              contents: [
                 { type: "text", text: "é ç´„æˆåŠŸ", weight: "bold", size: "xl", color: "#1bb57a", align: "center" },
                 { type: "text", text: `å…± ${list.length} å ‚èª²ç¨‹`, align: "center", color: "#666" }
              ]
           },
           footer: {
              type: "box", layout: "vertical",
              contents: [{ type: "button", style: "primary", color: "#1bb57a", action: { type: "uri", label: "æŸ¥çœ‹é ç´„", uri: "https://liff.line.me/" + LIFF_ID } }]
           }
        }
     };
  }

  // --- â˜…â˜…â˜… ç´€éŒ„èˆ‡å–æ¶ˆåŠŸèƒ½ (æ–°) â˜…â˜…â˜… ---
  
  async function loadHistory(){
     const listDiv = $('#historyList');
     const loading = $('#historyLoading');
     listDiv.innerHTML = '';
     loading.classList.remove('hide');
     
     try {
        // â˜… å‘¼å« Make å–å¾—ç´€éŒ„ (action: get_history)
        const res = await fetch(MAKE_WEBHOOK_URL, {
           method: 'POST', headers: {'Content-Type':'application/json'},
           body: JSON.stringify({ action: 'get_history', userId: state.uid })
        });
        const data = await res.json();
        const records = data.records || []; // é æœŸæ ¼å¼: [{id, date, time, coach, people, status}...]

        loading.classList.add('hide');
        if(records.length === 0){
           listDiv.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">ç›®å‰æ²’æœ‰é ç´„ç´€éŒ„</div>';
           return;
        }

        records.forEach(r => {
           const el = document.createElement('div');
           el.className = 'historyItem';
           // å¦‚æœæƒ³é¡¯ç¤ºå–æ¶ˆçš„ç´€éŒ„ï¼Œå¯ä»¥åŠ  class
           const isCanceled = r.status === 'canceled';
           if(isCanceled) el.classList.add('cancelled');

           const html = `
             <div style="display:flex;flex-direction:column;">
               <span style="font-size:15px;">${r.date} ${r.time}</span>
               <span style="font-size:12px;color:#888;">${r.coach}ï½œ${r.people}äºº</span>
             </div>
           `;
           el.innerHTML = html;

           // åªæœ‰æœªå–æ¶ˆçš„ä¸”æ™‚é–“é‚„æ²’åˆ°çš„ï¼Œæ‰é¡¯ç¤ºå–æ¶ˆæŒ‰éˆ•
           if(!isCanceled){
              const btn = document.createElement('div');
              btn.className = 'cancelBtn';
              btn.textContent = 'å–æ¶ˆ';
              btn.onclick = () => handleCancel(r.id || `${r.date}_${r.time}`, r.date, r.time);
              el.appendChild(btn);
           } else {
              el.innerHTML += '<div style="font-size:12px;color:#aaa;">å·²å–æ¶ˆ</div>';
           }
           listDiv.appendChild(el);
        });

     } catch(e) {
        console.error(e);
        loading.textContent = 'è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
     }
  }

  async function handleCancel(id, date, time){
     const result = await Swal.fire({
        title: 'ç¢ºå®šå–æ¶ˆ?',
        text: `å–æ¶ˆé ç´„ï¼š${date} ${time}`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#b23a2b',
        confirmButtonText: 'ç¢ºå®šå–æ¶ˆ',
        cancelButtonText: 'è¿”å›'
     });

     if(result.isConfirmed){
        try {
           Swal.showLoading();
           // â˜… å‘¼å« Make å–æ¶ˆ (action: cancel)
           await fetch(MAKE_WEBHOOK_URL, {
              method: 'POST', headers: {'Content-Type':'application/json'},
              body: JSON.stringify({ action: 'cancel', userId: state.uid, bookingId: id, date: date, time: time })
           });
           await Swal.fire({ icon:'success', title:'å·²å–æ¶ˆ', timer:1500, showConfirmButton:false });
           loadHistory(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
        } catch(e){
           Swal.fire('éŒ¯èª¤', 'å–æ¶ˆå¤±æ•—ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡', 'error');
        }
     }
  }

  // --- åˆå§‹åŒ– ---
  async function main(){
     initTabs();
     $('#btnRefresh').onclick = loadHistory;

     await liff.init({ liffId: LIFF_ID });
     if(!liff.isLoggedIn()){ liff.login(); return; }
     
     const p = await liff.getProfile();
     state.uid = p.userId;
     state.name = p.displayName;

     initBookingFlow();
  }
  main();

</script>
</body>
</html>
