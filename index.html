<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>æ”¯é»é‹å‹•_ç§èª²é ç´„</title>
  
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* åŸºç¤è®Šæ•¸èˆ‡è¨­å®š */
    :root{ --bg:#f6f7f8; --card:#ffffff; --text:#111; --muted:#7a7a7a; --primary:#1bb57a; --border:rgba(0,0,0,.08); --shadow:0 10px 26px rgba(0,0,0,.08); --radius:18px; --danger:#b23a2b; --safeB: env(safe-area-inset-bottom, 0px); --safeT: env(safe-area-inset-top, 0px); --warnBg:#fff7e6; --warnBorder:rgba(192,122,0,.18); --warnText:#7a4a00; --selBg:#e3f9ef; --selText:#0d7a55; }
    *{ box-sizing:border-box; }
    html, body{ height:100%; overflow:hidden; }
    body{ margin:0; font-family: system-ui, -apple-system, sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ height:100dvh; display:flex; flex-direction:column; max-width:560px; margin:0 auto; }
    
    .top{ padding:10px 14px 8px; padding-top:calc(10px + var(--safeT)); background:linear-gradient(180deg, #f6f7f8 75%, rgba(246,247,248,0)); flex:0 0 auto; }
    .steps{ display:flex; gap:10px; align-items:center; justify-content:space-between; background:var(--card); border:1px solid var(--border); border-radius:999px; padding:10px 12px; box-shadow:var(--shadow); }
    .step{ display:flex; align-items:center; gap:8px; flex:1; justify-content:center; min-width:0; }
    .dot{ width:30px; height:30px; border-radius:999px; background:#e9f7f0; color:var(--primary); font-weight:900; display:flex; align-items:center; justify-content:center; flex:0 0 auto; font-size:14px; }
    .dot.active{ background:var(--primary); color:#fff; }
    .label{ font-size:15px; font-weight:900; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .label.active{ color:var(--text); }

    .main{ flex:1 1 auto; overflow:hidden; padding:0 14px; display:flex; flex-direction:column; gap:12px; min-height:0; }
    .card{ background:var(--card); border-radius:var(--radius); border:1px solid var(--border); box-shadow:var(--shadow); padding:14px; overflow:hidden; display:flex; flex-direction:column; }
    .h{ margin:0 0 10px; font-weight:950; font-size:22px; color:#111; flex:0 0 auto; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    
    .chip{ padding:14px 16px; border-radius:16px; background:#eeeeee; font-weight:950; font-size:18px; cursor:pointer; user-select:none; border:2px solid transparent; min-width:140px; text-align:center; flex:1 1 0; }
    .chip.sel{ background:#dff4ea; border-color:rgba(27,181,122,.45); box-shadow:0 0 0 3px rgba(27,181,122,.14) inset; }
    .chip.peoplemp{ flex:1 1 0; min-width:140px; font-size:18px; }
    .chip.disabled{ opacity:.55; pointer-events:none; }

    .subTitle{ margin:14px 0 10px; font-weight:950; font-size:15px; color:#111; }

    .step2Box{ display:flex; flex-direction:column; gap:10px; height:100%; min-height:0; }
    .coachIntro{ display:flex; gap:10px; align-items:center; border:1px solid rgba(0,0,0,.08); border-radius:16px; padding:10px; background:#fff; flex:0 0 auto; }
    .avatar{ width:48px; height:48px; border-radius:999px; overflow:hidden; background:#ddd; flex:0 0 auto; }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .coachMeta{ flex:1; min-width:0; }
    .coachName{ font-weight:950; font-size:18px; margin:0 0 6px; }
    .tags{ display:flex; gap:6px; flex-wrap:wrap; }
    .tag{ padding:6px 9px; border-radius:999px; background:#eaf8f2; color:#157a55; font-weight:900; font-size:11px; }

    .cal{ border-radius:18px; border:1px solid rgba(0,0,0,.08); padding:10px; background:#fff; flex:0 0 auto; }
    .calHead{ display:grid; grid-template-columns:42px 1fr 42px; gap:10px; align-items:center; margin-bottom:6px; }
    .calBtn{ width:42px; height:42px; border-radius:14px; background:#fff; box-shadow:0 6px 16px rgba(0,0,0,.06); display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:22px; font-weight:950; color:#0d7a55; border:1px solid rgba(0,0,0,.08); }
    .calBtn.disabled{ opacity:0.3; pointer-events:none; background:#f0f0f0; color:#999; }
    .monthTitle{ text-align:center; font-weight:950; font-size:16px; }
    .weekStrip{ display:grid; grid-template-columns:repeat(7, 1fr); gap:8px; }
    .dayCell{ display:flex; flex-direction:column; align-items:center; gap:6px; padding:6px 0; border-radius:14px; border:1px solid rgba(0,0,0,.06); background:#fff; box-shadow:0 6px 16px rgba(0,0,0,.05); cursor:pointer; min-height:64px; }
    .dayCell.disabled{ opacity:.35; pointer-events:none; }
    .dayCell.hidden{ visibility:hidden; pointer-events:none; }
    .dayCell.sel .dateDot{ background:var(--primary); color:#fff; box-shadow:0 0 0 5px rgba(27,181,122,.14); }
    .dowTxt{ font-size:11px; font-weight:900; color:#666; }
    .dateDot{ width:34px; height:34px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:950; color:#111; }

    .slotsArea{ flex:1 1 auto; min-height:0; display:flex; flex-direction:column; gap:10px; overflow:hidden; }
    .tabs{ display:flex; gap:22px; border-bottom:2px solid rgba(0,0,0,.08); padding-bottom:8px; flex:0 0 auto; }
    .tab{ font-weight:950; font-size:16px; color:#666; cursor:pointer; padding-bottom:10px; position:relative; }
    .tab.active{ color:#111; }
    .tab.active::after{ content:""; position:absolute; left:0; right:0; bottom:-2px; height:5px; background:var(--primary); border-radius:999px; }
    .slotGrid{ flex:1 1 auto; min-height:0; display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; align-content:start; overflow:auto; padding-right:2px; }
    .slot{ padding:10px 0; border-radius:999px; background:#ededed; font-weight:950; font-size:13px; text-align:center; cursor:pointer; white-space:nowrap; border:2px solid transparent; }
    .slot.sel{ background:var(--selBg); color:var(--selText); border-color:rgba(27,181,122,.35); box-shadow:0 0 0 3px rgba(27,181,122,.14) inset; }
    .slot.disabled{ opacity:.35; pointer-events:none; }
    .slotTip{ grid-column:1 / -1; padding:8px 2px; font-size:12px; font-weight:900; color:var(--muted); }
    .slotTip.important{ color:var(--danger); font-size:14px; font-weight:950; }

    /* é ç´„æ¸…å–®æ¨£å¼ */
    .cartSection {
      margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.08);
      display: flex; flex-direction: column; gap: 6px; 
      flex: 0 0 auto; max-height: 120px; overflow-y: auto;
      background: #fafafa; border-radius: 12px; padding: 8px;
    }
    .cartTitle { font-size: 12px; font-weight: 900; color: #888; margin-bottom: 2px; padding-left: 4px; }
    .cartItem {
      display: flex; align-items: center; justify-content: space-between;
      background: #fff; border: 1px solid #ddd; border-left: 4px solid var(--primary);
      border-radius: 8px; padding: 6px 10px; font-size: 13px; font-weight: 950; color: #333;
      box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    }
    .cartActions { display: flex; align-items: center; gap: 8px; }
    
    /* åŒ…æœˆæŒ‰éˆ•æ¨£å¼ */
    .repeatBtn {
      font-size: 11px; padding: 3px 8px; border-radius: 6px;
      background: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb;
      cursor: pointer; font-weight: 900; transition: all 0.2s;
    }
    .repeatBtn:active { transform: scale(0.95); background: #bbdefb; }
    
    .delBtn {
      width: 24px; height: 24px; font-size: 18px;
      display: flex; align-items: center; justify-content: center;
      color: #ccc; cursor: pointer;
    }
    .delBtn:hover { color: var(--danger); }

    .confirmWrap{ display:flex; flex-direction:column; gap:12px; padding:4px 0 2px; min-height:0; }
    .confirmList { display:flex; flex-direction:column; gap:8px; margin-top:6px; max-height:200px; overflow-y:auto; }
    .confirmItem { background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:10px; font-size:14px; font-weight:900; color:#333; display:flex; justify-content:space-between; }

    /* æº«é¦¨æé†’ï¼šæš—ç´…è‰²æ¨£å¼ */
    .remindTitle{ width:100%; font-weight:950; font-size:12px; color:var(--danger); margin-top:2px; }
    .remindBox{ width:100%; border-radius:16px; border:1px solid rgba(178, 58, 43, 0.2); background:#fff5f5; padding:12px; font-size:12px; line-height:1.6; font-weight:900; color:var(--danger); }
    
    .footer{ flex:0 0 auto; padding:10px 14px calc(12px + var(--safeB)); background:linear-gradient(0deg, #f6f7f8 72%, rgba(246,247,248,0)); }
    .btnRow{ display:flex; gap:12px; }
    .btn{ flex:1; border:0; border-radius:16px; padding:14px 12px; font-size:16px; font-weight:950; cursor:pointer; box-shadow:var(--shadow); }
    .btnPrimary{ background:var(--primary); color:#fff; }
    .btnGhost{ background:#fff; color:#111; border:1px solid rgba(0,0,0,.10); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    
    .status{ margin-top:8px; font-size:12px; color:var(--muted); text-align:center; font-weight:900; min-height:18px; white-space:pre-wrap; }
    .statusError{ color:var(--danger); font-weight:950; }
    .hide{ display:none !important; }
    .swal2-popup { font-family: system-ui, -apple-system, sans-serif !important; border-radius: 20px !important; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="steps">
      <div class="step"> <div id="dot1" class="dot active">1</div> <div id="lab1" class="label active">é¸æ•™ç·´</div> </div>
      <div class="step"> <div id="dot2" class="dot">2</div> <div id="lab2" class="label">é¸æ—¥æœŸ</div> </div>
      <div class="step"> <div id="dot3" class="dot">3</div> <div id="lab3" class="label">ç¢ºèª</div> </div>
    </div>
  </div>

  <div class="main">
    <div id="card1" class="card">
      <div class="h">Step 1ï½œé¸æ“‡æ•™ç·´</div>
      <div id="coachRow" class="row"></div>
      <div class="subTitle">é¸æ“‡äººæ•¸</div>
      <div id="peopleRow" class="row"></div>
    </div>

    <div id="card2" class="card hide" style="flex:1; min-height:0;">
      <div class="step2Box">
        <div class="h">Step 2ï½œé¸æ“‡æ—¥æœŸåŠæ™‚æ®µ</div>
        <div class="coachIntro">
          <div class="avatar"><img id="coachAvatar2" alt="" /></div>
          <div class="coachMeta">
            <div id="coachName2" class="coachName">â€”</div>
            <div id="coachTags2" class="tags"></div>
          </div>
        </div>
        <div class="cal">
          <div class="calHead">
            <div id="prevWeek" class="calBtn">â€¹</div>
            <div id="monthTitle" class="monthTitle">â€”</div>
            <div id="nextWeek" class="calBtn">â€º</div>
          </div>
          <div id="weekStrip" class="weekStrip"></div>
        </div>
        <div class="slotsArea">
          <div class="tabs">
            <div class="tab active" data-tab="am">ä¸Šåˆ</div>
            <div class="tab" data-tab="pm">ä¸‹åˆ</div>
            <div class="tab" data-tab="night">æ™šä¸Š</div>
          </div>
          <div id="slotGrid2" class="slotGrid"></div>
        </div>
        
        <div class="cartSection">
            <div class="cartTitle">å·²é¸æ“‡é ç´„æ¸…å–®</div>
            <div id="cartList"></div>
        </div>
      </div>
    </div>

    <div id="card3" class="card hide" style="flex:1; min-height:0;">
      <div class="confirmWrap">
        <div class="h">Step 3ï½œç¢ºèªé ç´„å…§å®¹</div>
        <div class="infoBox" id="confirmInfo"></div>
        <div class="remindTitle">æº«é¦¨æé†’</div>
        <div class="remindBox">
          1. é ç´„åŠå–æ¶ˆè«‹åœ¨èª²å ‚é–‹å§‹å‰1å°æ™‚åŸ·è¡Œã€‚<br/>
          2. æœ¬ç³»çµ±å°‡ç‚ºæ‚¨é€å‡ºå¤šç­†é ç´„ä¸¦æª¢æ ¸ã€‚<br/>
          3. è‹¥æŸæ™‚æ®µå·²è¢«æ¶å…ˆé ç´„ï¼Œç³»çµ±æœƒæé†’ä¸¦å–æ¶ˆè·³éå·²è¢«é ç´„æ™‚æ®µã€‚
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="btnRow">
      <button id="btnBack" class="btn btnGhost hide">ä¸Šä¸€æ­¥</button>
      <button id="btnNext" class="btn btnPrimary" disabled>ä¸‹ä¸€æ­¥</button>
    </div>
    <div id="status" class="status">è¼‰å…¥ä¸­â€¦</div>
  </div>
</div>

<script>
  const LIFF_ID = '2008631386-AEejMove'; 
  const MAKE_OPTIONS_WEBHOOK_URL = 'https://hook.us2.make.com/895459nt1ywk5dtvr9x31tis495coyw3';
  const MAKE_BOOKING_WEBHOOK_URL = 'https://hook.us2.make.com/895459nt1ywk5dtvr9x31tis495coyw3';

  const COACHES = [
    { id:'coachA', name:'å‰éŠ˜', avatar:'https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=240&q=80', tags:['è‚ŒåŠ›è¨“ç·´','æ¨‚é½¡é‹å‹•','é’å°‘å¹´é«”èƒ½'] },
    { id:'coachB', name:'æ•™ç·´ B', avatar:'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=240&q=80', tags:['è‚ŒåŠ›è¨“ç·´','å§¿å‹¢èª¿æ•´','åˆå­¸å‹å–„'] },
  ];

  const state = {
    step: 1, uid: '', name: '', coach: null, people: null,
    weekStart: null, dateKey: null, tab: 'am',
    cart: [],
    optionsRaw: [], availabilityMap: {}, loadingOptions: false
  };

  const $ = s => document.querySelector(s);
  const dot1=$('#dot1'), dot2=$('#dot2'), dot3=$('#dot3');
  const lab1=$('#lab1'), lab2=$('#lab2'), lab3=$('#lab3');
  const card1=$('#card1'), card2=$('#card2'), card3=$('#card3');
  const coachRow=$('#coachRow'), peopleRow=$('#peopleRow');
  const btnBack=$('#btnBack'), btnNext=$('#btnNext'), status=$('#status');
  const coachAvatar2=$('#coachAvatar2'), coachName2=$('#coachName2'), coachTags2=$('#coachTags2');
  const prevWeek=$('#prevWeek'), nextWeek=$('#nextWeek'), monthTitle=$('#monthTitle');
  const weekStrip=$('#weekStrip'), slotGrid2=$('#slotGrid2'), confirmInfo=$('#confirmInfo');
  const cartList=$('#cartList'); 

  function pad2(n){ return String(n).padStart(2,'0'); }
  function ymd(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
  function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
  function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
  function weekStartMonday(d){ const x = startOfDay(d); const day = x.getDay(); return addDays(x, day === 0 ? -6 : 1 - day); }
  function monthYearLabel(ws){ return `${ws.getMonth()+1}æœˆ ${ws.getFullYear()}`; }
  function dowLabel(idx){ return ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'][idx] || ''; }
  function weekdayZhFromDateKey(dateKey){ return ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][new Date(dateKey+'T00:00:00').getDay()]||''; }
  function getLimitDate(){ const d = new Date(); d.setMonth(d.getMonth()+2,0); d.setHours(23,59,59,999); return d; }
  
  function canBookNow(dateKey, timeStr){
    if(!dateKey || !timeStr) return false;
    const dt = new Date(dateKey+'T00:00:00'); const [hh,mm]=timeStr.split(':');
    dt.setHours(hh,mm,0); return dt >= new Date(Date.now()+3600000);
  }
  
  function setStatus(msg, isError=false){ status.classList.toggle('statusError', !!isError); status.textContent = msg || ''; }

  // çµ±ä¸€æ›´æ–°ç‹€æ…‹åˆ— (ç°¡åŒ–ç‰ˆ)
  function updateStatusInStep2() {
      if(state.loadingOptions) {
          setStatus(`è®€å– ${state.coach.name} çš„å¯é ç´„æ™‚æ®µä¸­â€¦`);
      } else if(state.cart.length > 0) {
          setStatus(`å·²é¸æ“‡ ${state.cart.length} å ‚èª²`);
      } else if(!hasAnySlots()) {
          setStatus('ç›®å‰æ²’æœ‰å¯é ç´„çš„æ™‚æ®µ', true);
      } else if(state.dateKey) {
          setStatus(`å·²é¸æ—¥æœŸï¼š${state.dateKey}`);
      } else {
          setStatus('è«‹å…ˆé¸æ“‡ä¸Šæ–¹æ—¥æœŸ');
      }
  }

  function checkRecurringAvailable(startDateKey, timeStr) {
      let current = new Date(startDateKey + 'T00:00:00');
      for (let i = 1; i <= 3; i++) {
          current = addDays(current, 7);
          const dKey = ymd(current);
          const slotsForDay = state.availabilityMap[dKey];
          if (!slotsForDay || !slotsForDay.includes(timeStr)) return false; 
      }
      return true;
  }

  function step1StatusText(){
    if(!state.coach && !state.people) return `${state.name||'User'}æ‚¨å¥½ï¼Œè«‹é¸æ“‡æ•™ç·´èˆ‡äººæ•¸`;
    if(!state.coach) return `å·²é¸äººæ•¸ï¼š${state.people} äººï½œè«‹é¸æ“‡æ•™ç·´`;
    if(!state.people) return `å·²é¸æ•™ç·´ï¼š${state.coach.name}ï½œè«‹é¸æ“‡äººæ•¸`;
    return `å·²é¸ï¼š${state.coach.name} / ${state.people} äºº`;
  }

  function setStep(n){
    state.step = n;
    [dot1,dot2,dot3].forEach((d,i)=>d.classList.toggle('active', i+1===n));
    [lab1,lab2,lab3].forEach((l,i)=>l.classList.toggle('active', i+1===n));
    card1.classList.toggle('hide', n!==1); card2.classList.toggle('hide', n!==2); card3.classList.toggle('hide', n!==3);
    status.classList.remove('statusError');

    if(n===1){
      btnBack.classList.add('hide'); btnNext.textContent='ä¸‹ä¸€æ­¥';
      btnNext.disabled = !(state.coach && state.people);
      setStatus(step1StatusText());
    }
    if(n===2){
      btnBack.classList.remove('hide'); 
      updateNextButtonState(); 
      updateStatusInStep2();
      renderCart();
    }
    if(n===3){
      btnBack.classList.remove('hide'); btnNext.textContent='ç¢ºèªé€å‡º';
      btnNext.disabled = state.cart.length === 0;
      
      let html = `<div style="margin-bottom:8px;"><b>é ç´„æ•™ç·´ï¼š</b>${state.coach.name} (${state.people}äºº)</div>`;
      html += `<div class="confirmList">`;
      state.cart.sort((a,b)=>a.ts - b.ts).forEach(item=>{
        const wd = weekdayZhFromDateKey(item.date);
        html += `<div class="confirmItem"><span>${item.date} (${wd})</span> <span>${item.time}</span></div>`;
      });
      html += `</div>`;
      html += `<div style="text-align:right; margin-top:8px; font-size:13px; color:#666;">å…± ${state.cart.length} å ‚èª²</div>`;
      confirmInfo.innerHTML = html;
      setStatus('');
    }
  }

  // â˜… æŒ‰éˆ•ç‹€æ…‹æ›´æ–°ï¼šç´”ç²¹é¡¯ç¤ºä¸‹ä¸€æ­¥ â˜…
  function updateNextButtonState() {
      const count = state.cart.length;
      if (count > 0) {
          btnNext.textContent = `ä¸‹ä¸€æ­¥`;
          btnNext.disabled = false;
      } else {
          btnNext.textContent = 'ä¸‹ä¸€æ­¥';
          btnNext.disabled = true;
      }
  }

  function toggleCartItem(date, time) {
      const idx = state.cart.findIndex(i => i.date === date && i.time === time);
      if (idx >= 0) { state.cart.splice(idx, 1); } 
      else { const d = new Date(date + 'T' + time); state.cart.push({ date: date, time: time, ts: d.getTime() }); }
      renderCart(); 
      renderSlotsStep2();
      updateNextButtonState();
      updateStatusInStep2();
  }

  function addBatchItems(startDateKey, timeStr, weeks = 4) {
      let current = new Date(startDateKey + 'T00:00:00');
      current = addDays(current, 7);
      let addedCount = 0;
      for (let i = 0; i < (weeks - 1); i++) {
          const dKey = ymd(current);
          const exists = state.cart.some(item => item.date === dKey && item.time === timeStr);
          const validTime = canBookNow(dKey, timeStr);
          if (!exists && validTime) {
             state.cart.push({ date: dKey, time: timeStr, ts: current.getTime() + parseInt(timeStr.split(':')[0])*3600000 });
             addedCount++;
          }
          current = addDays(current, 7);
      }
      return addedCount;
  }

  function renderCart() {
      cartList.innerHTML = '';
      if (state.cart.length === 0) {
          cartList.innerHTML = '<div style="font-size:12px; color:#aaa; text-align:center; padding:10px;">å°šæœªé¸æ“‡æ™‚æ®µ</div>';
          return;
      }
      const sorted = [...state.cart].sort((a,b) => a.ts - b.ts);
      sorted.forEach(item => {
          const el = document.createElement('div');
          el.className = 'cartItem';
          const wd = weekdayZhFromDateKey(item.date);
          const isRecurringEligible = checkRecurringAvailable(item.date, item.time);
          
          let btnHtml = '';
          if (isRecurringEligible) {
             btnHtml = `<div class="repeatBtn" title="è‡ªå‹•åŠ å…¥æœªä¾† 3 é€±çš„åŒä¸€æ™‚æ®µ">+åŒ…æœˆ</div>`;
          }

          el.innerHTML = `
            <span>${item.date} (${wd}) ${item.time}</span>
            <div class="cartActions">
               ${btnHtml}
               <div class="delBtn">Ã—</div>
            </div>
          `;
          
          const repeatBtn = el.querySelector('.repeatBtn');
          if(repeatBtn) {
              repeatBtn.onclick = (e) => {
                 e.stopPropagation();
                 // â˜… å„ªåŒ–æç¤ºï¼šåŠ å…¥æ—¥æœŸã€æ˜ŸæœŸèˆ‡æ™‚æ®µå¼·èª¿ â˜…
                 Swal.fire({
                     title: 'ä¸€éµåŒ…æœˆ',
                     html: `è¦åŠ å…¥ ${item.date} å¾ŒçºŒ 3 é€±<br><b style="color:#d33; font-size:1.1em;">æ¯é€±${wd} ${item.time}</b> æ™‚æ®µçš„é ç´„å—ï¼Ÿ`,
                     icon: 'question',
                     showCancelButton: true,
                     confirmButtonText: 'åŠ å…¥',
                     confirmButtonColor: '#1bb57a',
                     cancelButtonText: 'å–æ¶ˆ'
                 }).then((res)=>{
                     if(res.isConfirmed){
                         const c = addBatchItems(item.date, item.time, 4);
                         renderCart(); renderSlotsStep2(); updateNextButtonState(); updateStatusInStep2();
                         Swal.fire({ icon:'success', title:'å·²åŠ å…¥', text:`æˆåŠŸåŠ å…¥å¾ŒçºŒ ${c} å ‚èª²`, timer:1500, showConfirmButton:false });
                     }
                 });
              };
          }

          el.querySelector('.delBtn').onclick = (e) => { 
             e.stopPropagation(); 
             toggleCartItem(item.date, item.time); 
          };
          
          cartList.appendChild(el);
      });
  }

  function renderCoaches(){
    coachRow.innerHTML='';
    COACHES.forEach(c=>{
      const div=document.createElement('div');
      div.className='chip'+(state.coach?.id===c.id?' sel':''); div.textContent=c.name;
      div.onclick=()=>{ state.coach=c; renderCoaches(); renderPeople(); btnNext.disabled=!(state.coach && state.people); setStatus(step1StatusText()); };
      coachRow.appendChild(div);
    });
  }
  
  function renderPeople(){
    peopleRow.innerHTML='';
    [1,2].forEach(n=>{
      const div=document.createElement('div');
      div.className = 'chip peoplemp' + (state.people===n ? ' sel' : ''); div.textContent = `${n} äºº`;
      div.onclick=()=>{ state.people=n; renderPeople(); btnNext.disabled=!(state.coach && state.people); setStatus(step1StatusText()); };
      peopleRow.appendChild(div);
    });
  }

  function renderCoachIntro(){
    if(!state.coach) return;
    coachAvatar2.src = state.coach.avatar; coachName2.textContent = state.coach.name; coachTags2.innerHTML='';
    state.coach.tags.forEach(t=>{ const el=document.createElement('div'); el.className='tag'; el.textContent=t; coachTags2.appendChild(el); });
  }
  function hasAnySlots(){ return state.optionsRaw && state.optionsRaw.length > 0; }
  function buildAvailabilityMap(options){
    const map = {};
    (options||[]).forEach(o=>{
      const raw = (o.value || o.label || '').toString();
      const m = raw.match(/^(\d{4})[\/-](\d{2})[\/-](\d{2})\s+(\d{2}:\d{2})$/);
      if(!m) return;
      const k=`${m[1]}-${m[2]}-${m[3]}`, t=m[4];
      if(!map[k]) map[k]=[]; if(!map[k].includes(t)) map[k].push(t);
    });
    Object.keys(map).forEach(k=>map[k].sort()); return map;
  }
  
  function renderWeekStrip(){
    const ws = state.weekStart; monthTitle.textContent = monthYearLabel(ws); weekStrip.innerHTML='';
    const today0 = startOfDay(new Date()); const limitDate = getLimitDate();
    prevWeek.classList.toggle('disabled', ws <= weekStartMonday(new Date()));
    nextWeek.classList.toggle('disabled', addDays(ws,7) > limitDate);
    
    for(let i=0;i<7;i++){
      const d = addDays(ws, i); const key = ymd(d);
      const cell=document.createElement('div'); cell.className='dayCell';
      const isOver = d > limitDate;
      if((startOfDay(d) < today0) || !state.availabilityMap[key] || isOver || state.loadingOptions) cell.classList.add('disabled');
      if(isOver) cell.classList.add('hidden');
      if(state.dateKey===key) cell.classList.add('sel');
      
      const dow=document.createElement('div'); dow.className='dowTxt'; dow.textContent=dowLabel(i);
      const dot=document.createElement('div'); dot.className='dateDot'; dot.textContent=d.getDate();
      cell.append(dow, dot);
      cell.onclick=()=>{
        if(cell.classList.contains('disabled')) return;
        state.dateKey=key; 
        renderWeekStrip(); renderSlotsStep2(); 
        updateStatusInStep2();
      };
      weekStrip.appendChild(cell);
    }
  }

  function renderSlotsStep2(){
    slotGrid2.innerHTML='';
    if(state.loadingOptions){ slotGrid2.innerHTML='<div class="slotTip important">è®€å–å¯é ç´„æ™‚æ®µä¸­â€¦</div>'; return; }
    if(!hasAnySlots()){ slotGrid2.innerHTML='<div class="slotTip error">ç›®å‰æ²’æœ‰å¯é ç´„çš„æ™‚æ®µ</div>'; return; }
    if(!state.dateKey){ slotGrid2.innerHTML='<div class="slotTip important">è«‹å…ˆé¸æ“‡ä¸Šæ–¹æ—¥æœŸ</div>'; return; }
    
    const list = (state.availabilityMap[state.dateKey]||[]).filter(t=>{
      const h=parseInt(t); return state.tab==='am'?(h<12):state.tab==='pm'?(h>=12&&h<18):(h>=18);
    });
    if(list.length===0){ slotGrid2.innerHTML='<div class="slotTip important">æ­¤æ™‚æ®µç„¡å¯é ç´„æ™‚é–“</div>'; return; }
    
    list.forEach(t=>{
      const disabled = !canBookNow(state.dateKey, t);
      const isSelected = state.cart.some(item => item.date === state.dateKey && item.time === t);
      
      const div=document.createElement('div'); 
      div.className='slot'+(disabled?' disabled':'')+(isSelected?' sel':'');
      div.textContent=t;
      
      div.onclick=async ()=>{ 
        if(disabled) return; 
        toggleCartItem(state.dateKey, t);
      };
      slotGrid2.appendChild(div);
    });
  }
  
  async function loadOptionsForCoach(){
    state.loadingOptions=true; state.optionsRaw=[]; state.availabilityMap={}; state.dateKey=null; state.cart=[]; 
    setStep(2); renderCoachIntro(); renderWeekStrip(); renderSlotsStep2(); renderCart();
    try{
      const res = await fetch(MAKE_OPTIONS_WEBHOOK_URL, {
         method: "POST", headers: {"Content-Type":"application/json"},
         body: JSON.stringify({ action:"getOptions", coachName:state.coach.name, coachId:state.coach.id, people:state.people, userId:state.uid })
      });
      const data = await res.json();
      state.optionsRaw = (data&&Array.isArray(data.options))?data.options:[];
      state.availabilityMap = buildAvailabilityMap(state.optionsRaw);
    }catch(e){ console.error(e); }
    state.loadingOptions=false; renderWeekStrip(); renderSlotsStep2();
    updateStatusInStep2();
  }

  function buildBatchBookingData(){
    return {
      action: "book", 
      userId: state.uid,
      displayName: state.name,
      coachName: state.coach.name,
      people: state.people,
      bookings: state.cart.map(item => ({ date: item.date, time: item.time, weekday: weekdayZhFromDateKey(item.date) })),
      createdAt: new Date().toISOString()
    };
  }

  async function init(){
    renderCoaches(); renderPeople(); state.weekStart = weekStartMonday(new Date()); renderWeekStrip();
    
    document.querySelectorAll('.tab').forEach(el=>el.onclick=()=>{
       document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); el.classList.add('active');
       state.tab=el.dataset.tab; renderSlotsStep2();
    });

    btnBack.onclick=()=>{ if(state.step===2) setStep(1); else setStep(2); };

    btnNext.onclick=async ()=>{
      if(state.step===1){ await loadOptionsForCoach(); return; }
      if(state.step===2){ setStep(3); return; }
      if(state.step===3){
        btnNext.disabled=true; btnNext.textContent="è™•ç†ä¸­..."; setStatus("æ­£åœ¨é€å‡ºé ç´„...");
        try{
           const res = await fetch(MAKE_BOOKING_WEBHOOK_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(buildBatchBookingData()) });
           const result = await res.json();
           
           const results = result.results || [];
           const successList = results.filter(r => r.status === 'success');
           const failedList = results.filter(r => r.status !== 'success');

           if (failedList.length === 0 && successList.length > 0) {
              await Swal.fire({ icon:'success', title:'é ç´„æˆåŠŸ', text:`${successList.length} å ‚èª²çš†å·²é ç´„å®Œæˆï¼`, confirmButtonColor: '#1bb57a' });
              if(liff.isInClient()) await liff.sendMessages([{ type:"text", text:`ğŸ‰ æˆåŠŸé ç´„ ${successList.length} å ‚ç§èª²ï¼` }]);
              liff.closeWindow();

           } else if (successList.length === 0) {
              await Swal.fire({ icon:'error', title:'é ç´„å¤±æ•—', html:'å¾ˆæŠ±æ­‰ï¼Œæ‰€é¸æ™‚æ®µçš†å·²è¢«é ç´„ï¼Œè«‹é‡æ–°é¸æ“‡ã€‚', confirmButtonText:'é‡æ–°é¸æ“‡' });
              btnNext.disabled=false; btnNext.textContent="ç¢ºèªé€å‡º";

           } else {
              let failMsg = failedList.map(f => `<li>${f.date}: ${f.msg||'é¡æ»¿'}</li>`).join('');
              await Swal.fire({
                  icon: 'warning',
                  title: 'éƒ¨åˆ†é ç´„å®Œæˆ',
                  html: `<div style="text-align:left;">æˆåŠŸï¼š<b>${successList.length}</b> å ‚<br/><span style="color:#d33">å¤±æ•—ï¼š<b>${failedList.length}</b> å ‚</span><ul style="margin-top:5px; padding-left:20px; color:#d33;">${failMsg}</ul></div>`,
                  confirmButtonText: 'äº†è§£'
              });
              liff.closeWindow();
           }
        }catch(e){ 
            console.error(e);
            // â˜… ä¿®æ”¹ 4ï¼šæ›´æ–°éŒ¯èª¤è¨Šæ¯ â˜…
            Swal.fire({ icon:'error', title:'éŒ¯èª¤', text:'ç³»çµ±ç•°å¸¸ï¼Œè«‹è¯ç¹«æ•™ç·´è™•ç†ã€‚' }); 
            btnNext.disabled=false; btnNext.textContent="ç¢ºèªé€å‡º"; 
        }
      }
    };
    setStep(1);
    try { await liff.init({ liffId: LIFF_ID }); if(!liff.isLoggedIn()) liff.login(); const p = await liff.getProfile(); state.uid = p.userId; state.name = p.displayName; } catch(err) { console.error('LIFF Init failed:', err); }
  }
  init();
</script>
</body>
</html>
