<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>支點運動_私課預約</title>
  
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{ --bg:#f6f7f8; --card:#ffffff; --text:#111; --muted:#7a7a7a; --primary:#1bb57a; --border:rgba(0,0,0,.08); --shadow:0 10px 26px rgba(0,0,0,.08); --radius:18px; --danger:#b23a2b; --safeB: env(safe-area-inset-bottom, 0px); --safeT: env(safe-area-inset-top, 0px); --selBg:#e3f9ef; --selText:#0d7a55; }
    *{ box-sizing:border-box; }
    html, body{ height:100%; overflow:hidden; }
    body{ margin:0; font-family: system-ui, -apple-system, sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ height:100dvh; display:flex; flex-direction:column; max-width:560px; margin:0 auto; }
    
    .top{ padding:10px 14px 8px; padding-top:calc(10px + var(--safeT)); background:linear-gradient(180deg, #f6f7f8 75%, rgba(246,247,248,0)); flex:0 0 auto; }
    .steps{ display:flex; gap:10px; align-items:center; justify-content:space-between; background:var(--card); border:1px solid var(--border); border-radius:999px; padding:10px 12px; box-shadow:var(--shadow); }
    .step{ display:flex; align-items:center; gap:8px; flex:1; justify-content:center; min-width:0; }
    .dot{ width:30px; height:30px; border-radius:999px; background:#e9f7f0; color:var(--primary); font-weight:900; display:flex; align-items:center; justify-content:center; flex:0 0 auto; font-size:14px; }
    .dot.active{ background:var(--primary); color:#fff; }
    .label{ font-size:15px; font-weight:900; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .label.active{ color:var(--text); }

    .main{ flex:1 1 auto; overflow:hidden; padding:0 14px; display:flex; flex-direction:column; gap:12px; min-height:0; }
    .card{ background:var(--card); border-radius:var(--radius); border:1px solid var(--border); box-shadow:var(--shadow); padding:14px; overflow:hidden; display:flex; flex-direction:column; }
    .h{ margin:0 0 10px; font-weight:950; font-size:22px; color:#111; flex:0 0 auto; }
    
    .chip{ padding:14px 16px; border-radius:16px; background:#eeeeee; font-weight:950; font-size:18px; cursor:pointer; user-select:none; border:2px solid transparent; min-width:140px; text-align:center; flex:1 1 0; }
    .chip.sel{ background:#dff4ea; border-color:rgba(27,181,122,.45); box-shadow:0 0 0 3px rgba(27,181,122,.14) inset; }

    .step2Box{ display:flex; flex-direction:column; gap:10px; height:100%; min-height:0; }
    .coachIntro{ display:flex; gap:10px; align-items:center; border:1px solid rgba(0,0,0,.08); border-radius:16px; padding:10px; background:#fff; flex:0 0 auto; }
    .avatar{ width:48px; height:48px; border-radius:999px; overflow:hidden; background:#ddd; flex:0 0 auto; }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .coachName{ font-weight:950; font-size:18px; }

    .cal{ border-radius:18px; border:1px solid rgba(0,0,0,.08); padding:10px; background:#fff; flex:0 0 auto; }
    .calHead{ display:grid; grid-template-columns:42px 1fr 42px; gap:10px; align-items:center; margin-bottom:6px; }
    .calBtn{ width:42px; height:42px; border-radius:14px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:22px; font-weight:950; color:#0d7a55; border:1px solid rgba(0,0,0,.08); }
    .weekStrip{ display:grid; grid-template-columns:repeat(7, 1fr); gap:8px; }
    .dayCell{ display:flex; flex-direction:column; align-items:center; gap:6px; padding:6px 0; border-radius:14px; border:1px solid rgba(0,0,0,.06); background:#fff; cursor:pointer; min-height:64px; }
    .dayCell.sel .dateDot{ background:var(--primary); color:#fff; }

    .slotsArea{ flex:1 1 auto; min-height:0; display:flex; flex-direction:column; gap:10px; overflow:hidden; }
    .tabs{ display:flex; gap:22px; border-bottom:2px solid rgba(0,0,0,.08); padding-bottom:8px; }
    .tab{ font-weight:950; font-size:16px; color:#666; cursor:pointer; padding-bottom:10px; position:relative; }
    .tab.active{ color:#111; }
    .tab.active::after{ content:""; position:absolute; left:0; right:0; bottom:-2px; height:5px; background:var(--primary); border-radius:999px; }
    .slotGrid{ flex:1 1 auto; min-height:0; display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; align-content:start; overflow:auto; }
    .slot{ padding:10px 0; border-radius:999px; background:#ededed; font-weight:950; font-size:13px; text-align:center; cursor:pointer; border:2px solid transparent; }
    .slot.sel{ background:var(--selBg); color:var(--selText); border-color:rgba(27,181,122,.35); }

    .cartSection { margin-top: 8px; padding: 8px; border-top: 1px solid rgba(0,0,0,0.08); background: #fafafa; border-radius: 12px; max-height: 120px; overflow-y: auto; }
    .cartItem { display: flex; align-items: center; justify-content: space-between; background: #fff; border: 1px solid #ddd; border-left: 4px solid var(--primary); border-radius: 8px; padding: 6px 10px; font-size: 13px; font-weight: 950; margin-bottom: 4px; }

    /* Step 3 間距修正 */
    .confirmList { display:flex; flex-direction:column; gap:12px; margin-top:10px; max-height:240px; overflow-y:auto; padding: 4px; }
    .confirmItem { background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:16px 20px; font-size:16px; font-weight:900; color:#333; display:flex; justify-content:space-between; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }

    .remindTitle{ width:100%; font-weight:950; font-size:16px; color:#b22222; margin-top:15px; margin-bottom: 6px; }
    .remindBox{ width:100%; border-radius:16px; border:1px solid rgba(178, 34, 34, 0.2); background:#fff5f5; padding:14px; font-size:14px; line-height:1.7; font-weight:900; color:#b22222; }
    
    .footer{ flex:0 0 auto; padding:10px 14px calc(12px + var(--safeB)); }
    .btnRow{ display:flex; gap:12px; }
    .btn{ flex:1; border:0; border-radius:16px; padding:14px 12px; font-size:16px; font-weight:950; cursor:pointer; }
    .btnPrimary{ background:var(--primary); color:#fff; }
    .btnGhost{ background:#fff; color:#111; border:1px solid rgba(0,0,0,.10); }
    .btn:disabled{ opacity:.45; }
    
    .status{ margin-top:8px; font-size:12px; color:var(--muted); text-align:center; font-weight:900; }
    .hide{ display:none !important; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="steps">
      <div class="step"> <div id="dot1" class="dot active">1</div> <div id="lab1" class="label active">選教練</div> </div>
      <div class="step"> <div id="dot2" class="dot">2</div> <div id="lab2" class="label">選日期</div> </div>
      <div class="step"> <div id="dot3" class="dot">3</div> <div id="lab3" class="label">確認</div> </div>
    </div>
  </div>

  <div class="main">
    <div id="card1" class="card">
      <div class="h">Step 1｜選擇教練</div>
      <div id="coachRow" style="display:flex; gap:12px; flex-wrap:wrap;"></div>
      <div style="margin:14px 0 10px; font-weight:950;">選擇人數</div>
      <div id="peopleRow" style="display:flex; gap:12px; flex-wrap:wrap;"></div>
    </div>

    <div id="card2" class="card hide" style="flex:1;">
      <div class="step2Box">
        <div class="h">Step 2｜選擇日期時段</div>
        <div class="coachIntro">
          <div class="avatar"><img id="coachAvatar2" src="" /></div>
          <div class="coachName" id="coachName2">—</div>
        </div>
        <div class="cal">
          <div class="calHead">
            <div id="prevWeek" class="calBtn">‹</div>
            <div id="monthTitle" style="text-align:center; font-weight:950;">—</div>
            <div id="nextWeek" class="calBtn">›</div>
          </div>
          <div id="weekStrip" class="weekStrip"></div>
        </div>
        <div class="slotsArea">
          <div class="tabs">
            <div class="tab active" data-tab="am">上午</div>
            <div class="tab" data-tab="pm">下午</div>
            <div class="tab" data-tab="night">晚上</div>
          </div>
          <div id="slotGrid2" class="slotGrid"></div>
        </div>
        <div class="cartSection"><div id="cartList"></div></div>
      </div>
    </div>

    <div id="card3" class="card hide" style="flex:1;">
      <div class="confirmWrap">
        <div class="h">Step 3｜確認預約時段</div>
        <div id="confirmInfo"></div>
        <div class="remindTitle">溫馨提醒</div>
        <div class="remindBox">
          <ol style="margin: 0; padding-left: 20px;">
            <li>取消或改期，請於開課前 2 小時完成。</li>
            <li>若某時段已被預約，將直接取消該時段預約。</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="btnRow">
      <button id="btnBack" class="btn btnGhost hide">上一步</button>
      <button id="btnNext" class="btn btnPrimary" disabled>下一步</button>
    </div>
    <div id="status" class="status">載入中…</div>
  </div>
</div>

<script>
  const LIFF_ID = '2008631386-AEejMove'; 
  const MAKE_OPTIONS_WEBHOOK_URL = 'https://hook.us2.make.com/895459nt1ywk5dtvr9x31tis495coyw3';
  const MAKE_BOOKING_WEBHOOK_URL = 'https://hook.us2.make.com/895459nt1ywk5dtvr9x31tis495coyw3';

  const COACHES = [
    { id:'coachA', name:'偉銘', avatar:'https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=240', tags:['肌力訓練'] },
    { id:'coachB', name:'教練 B', avatar:'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=240', tags:['姿勢調整'] }
  ];

  const state = { step: 1, uid: '', name: '', coach: null, people: null, weekStart: null, dateKey: null, tab: 'am', cart: [], optionsRaw: [], availabilityMap: {} };

  const $ = s => document.querySelector(s);
  const pad2 = n => String(n).padStart(2,'0');
  const ymd = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };
  const weekdayZh = dk => ['日','一','二','三','四','五','六'][new Date(dk+'T00:00:00').getDay()];

  function setStep(n){
    state.step = n;
    [1,2,3].forEach(i => {
      $('#dot'+i).classList.toggle('active', i===n);
      $('#lab'+i).classList.toggle('active', i===n);
      $('#card'+i).classList.toggle('hide', i!==n);
    });
    if(n===1){ $('#btnBack').classList.add('hide'); $('#btnNext').textContent='下一步'; $('#btnNext').disabled = !(state.coach && state.people); }
    if(n===2){ $('#btnBack').classList.remove('hide'); $('#btnNext').disabled = state.cart.length === 0; renderCart(); }
    if(n===3){
      $('#btnBack').classList.remove('hide'); $('#btnNext').textContent='確認送出';
      let html = `<div style="margin-bottom:10px;"><b>預約教練：</b>${state.coach.name}</div><div class="confirmList">`;
      state.cart.sort((a,b)=>a.ts-b.ts).forEach(item => {
        html += `<div class="confirmItem"><span>${item.date} (${weekdayZh(item.date)})</span> <span>${item.time}</span></div>`;
      });
      html += `</div><div style="text-align:right; margin-top:12px; font-weight:950;">共 ${state.cart.length} 堂課</div>`;
      $('#confirmInfo').innerHTML = html;
    }
  }

  function renderCart() {
    $('#cartList').innerHTML = state.cart.length ? '' : '<div style="color:#aaa; text-align:center; font-size:12px;">尚未選擇時段</div>';
    state.cart.sort((a,b)=>a.ts-b.ts).forEach(item => {
      const el = document.createElement('div'); el.className = 'cartItem';
      el.innerHTML = `<span>${item.date} (${weekdayZh(item.date)}) ${item.time}</span><div style="cursor:pointer; color:#ccc;" onclick="toggleSlot('${item.date}','${item.time}')">×</div>`;
      $('#cartList').appendChild(el);
    });
  }

  function toggleSlot(date, time) {
    const idx = state.cart.findIndex(i => i.date === date && i.time === time);
    if(idx >= 0) state.cart.splice(idx, 1);
    else state.cart.push({ date, time, ts: new Date(date+'T'+time).getTime() });
    renderCart(); renderSlots(); $('#btnNext').disabled = state.cart.length === 0;
  }

  async function loadOptions(){
    $('#status').textContent = '讀取時段中...';
    try {
      const res = await fetch(MAKE_OPTIONS_WEBHOOK_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ action:"getOptions", coachName:state.coach.name }) });
      const data = await res.json();
      state.optionsRaw = data.options || [];
      state.availabilityMap = {};
      state.optionsRaw.forEach(o => {
        const m = (o.value||'').match(/^(\d{4}-\d{2}-\d{2})\s+(\d{2}:\d{2})$/);
        if(m){ if(!state.availabilityMap[m[1]]) state.availabilityMap[m[1]]=[]; state.availabilityMap[m[1]].push(m[2]); }
      });
    } catch(e) {}
    $('#status').textContent = ''; renderWeek();
  }

  function renderWeek(){
    $('#monthTitle').textContent = `${state.weekStart.getMonth()+1}月 ${state.weekStart.getFullYear()}`;
    $('#weekStrip').innerHTML = '';
    for(let i=0; i<7; i++){
      const d = addDays(state.weekStart, i); const key = ymd(d);
      const cell = document.createElement('div'); cell.className = 'dayCell' + (state.dateKey===key?' sel':'');
      if(!state.availabilityMap[key]) cell.style.opacity = '0.3';
      cell.innerHTML = `<div style="font-size:11px;">${['一','二','三','四','五','六','日'][i]}</div><div class="dateDot">${d.getDate()}</div>`;
      cell.onclick = () => { state.dateKey=key; renderWeek(); renderSlots(); };
      $('#weekStrip').appendChild(cell);
    }
    renderSlots();
  }

  function renderSlots(){
    $('#slotGrid2').innerHTML = state.dateKey ? '' : '<div style="grid-column:1/-1; text-align:center; color:#888;">請選擇日期</div>';
    if(!state.dateKey) return;
    const list = (state.availabilityMap[state.dateKey]||[]).filter(t => {
      const h = parseInt(t); return state.tab==='am'?(h<12):state.tab==='pm'?(h>=12&&h<18):(h>=18);
    });
    if(!list.length) $('#slotGrid2').innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#b22222;">此時段無課</div>';
    list.forEach(t => {
      const sel = state.cart.some(i => i.date===state.dateKey && i.time===t);
      const div = document.createElement('div'); div.className = 'slot' + (sel?' sel':''); div.textContent = t;
      div.onclick = () => toggleSlot(state.dateKey, t);
      $('#slotGrid2').appendChild(div);
    });
  }

  function createFlex(count) {
    return {
      type: "flex", altText: "預約成功",
      contents: {
        type: "bubble",
        header: { type: "box", layout: "vertical", backgroundColor: "#1bb57a", paddingAll: "20px", contents: [{ type: "text", text: "私課預約成功", weight: "bold", size: "xl", color: "#ffffff" }, { type: "text", text: "支點運動空間", size: "xs", color: "#eeeeee", margin: "sm" }] },
        body: { type: "box", layout: "vertical", paddingAll: "20px", contents: [
          { type: "box", layout: "vertical", backgroundColor: "#f5fcf9", cornerRadius: "10px", paddingAll: "16px", contents: [{ type: "text", text: `已成功預約 ${count} 堂私課`, weight: "bold", align: "center" }] },
          { type: "text", text: "溫馨提醒", margin: "xl", weight: "bold", size: "sm", color: "#b22222" },
          { type: "text", text: "1. 取消或改期，請於開課前 2 小時完成。", margin: "sm", size: "xs", color: "#b22222", wrap: true },
          { type: "text", text: "2. 如有任何問題，請於官方 Line 聯繫我們。", margin: "sm", size: "xs", color: "#b22222", wrap: true }
        ]},
        footer: { type: "box", layout: "vertical", paddingAll: "20px", contents: [{ type: "button", action: { type: "message", label: "查看預約", text: "查看預約" }, style: "primary", color: "#1bb57a" }] }
      }
    };
  }

  async function init(){
    COACHES.forEach(c => {
      const d = document.createElement('div'); d.className='chip'; d.textContent=c.name;
      d.onclick=()=>{ state.coach=c; Array.from($('#coachRow').children).forEach(el=>el.classList.remove('sel')); d.classList.add('sel'); setStep(1); };
      $('#coachRow').appendChild(d);
    });
    [1,2].forEach(n => {
      const d = document.createElement('div'); d.className='chip'; d.textContent=n+' 人';
      d.onclick=()=>{ state.people=n; Array.from($('#peopleRow').children).forEach(el=>el.classList.remove('sel')); d.classList.add('sel'); setStep(1); };
      $('#peopleRow').appendChild(d);
    });

    $('#btnNext').onclick = async () => {
      if(state.step===1){ await loadOptions(); setStep(2); $('#coachAvatar2').src=state.coach.avatar; $('#coachName2').textContent=state.coach.name; }
      else if(state.step===2) setStep(3);
      else {
        $('#btnNext').disabled = true; $('#status').textContent = '預約送出中...';
        try {
          const res = await fetch(MAKE_BOOKING_WEBHOOK_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ action:"book", userId:state.uid, displayName:state.name, coachName:state.coach.name, people:state.people, bookings:state.cart }) });
          const result = await res.json();
          // 修正判斷邏輯：只要結果不是明確報錯，且有成功清單
          const successCount = (result.results || []).filter(r => r.status === 'success').length;
          
          if(successCount > 0){
            await Swal.fire({ icon:'success', title:'預約成功', text:`已完成 ${successCount} 堂預約`, confirmButtonColor:'#1bb57a' });
            if(liff.isInClient()){
              try { await liff.sendMessages([createFlex(successCount)]); } catch(e){ console.log("Card send failed"); }
            }
            liff.closeWindow();
          } else {
            throw new Error("fail");
          }
        } catch(e) {
          Swal.fire({ icon:'error', title:'系統異常', text:'請聯繫教練處理。' });
          $('#btnNext').disabled = false;
        }
        $('#status').textContent = '';
      }
    };

    $('#btnBack').onclick = () => setStep(state.step-1);
    document.querySelectorAll('.tab').forEach(t => t.onclick = () => {
      document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active')); t.classList.add('active');
      state.tab = t.dataset.tab; renderSlots();
    });

    state.weekStart = (() => { const d = new Date(); d.setDate(d.getDate() - (d.getDay()===0?6:d.getDay()-1)); return d; })();
    $('#prevWeek').onclick = () => { state.weekStart = addDays(state.weekStart, -7); renderWeek(); };
    $('#nextWeek').onclick = () => { state.weekStart = addDays(state.weekStart, 7); renderWeek(); };

    try {
      await liff.init({ liffId: LIFF_ID });
      if(!liff.isLoggedIn()) liff.login();
      const p = await liff.getProfile(); state.uid=p.userId; state.name=p.displayName;
    } catch(e){}
    setStep(1); $('#status').textContent = '';
  }
  init();
</script>
</body>
</html>
